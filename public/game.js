var ee=Object.defineProperty;var $e=Object.getOwnPropertyDescriptor;var ke=Object.getOwnPropertyNames;var _e=Object.prototype.hasOwnProperty;var te=(c,a)=>()=>(c&&(a=c(c=0)),a);var Be=(c,a)=>{for(var t in a)ee(c,t,{get:a[t],enumerable:!0})},De=(c,a,t,e)=>{if(a&&typeof a=="object"||typeof a=="function")for(let n of ke(a))!_e.call(c,n)&&n!==t&&ee(c,n,{get:()=>a[n],enumerable:!(e=$e(a,n))||e.enumerable});return c};var Ge=c=>De(ee({},"__esModule",{value:!0}),c);function de(c){return B=new ae(c),B}function g(){if(!B)throw new Error("RNG not initialized. Call initializeRNG() first.");return B}function y(){return B!==null}function ue(c){let a="abcdefghijklmnopqrstuvwxyz0123456789_-".split("");return y()?Array.from({length:c},()=>g().choice(a)).join(""):Array.from({length:c},()=>a[Math.floor(Math.random()*a.length)]).join("")}var ae,B,v=te(()=>{"use strict";ae=class{constructor(a){typeof a=="string"?this.seed=this.hashString(a):this.seed=a}hashString(a){let t=0;for(let e=0;e<a.length;e++){let n=a.charCodeAt(e);t=(t<<5)-t+n,t=t&t}return Math.abs(t)}next(){let a=this.seed+=1831565813;return a=Math.imul(a^a>>>15,a|1),a^=a+Math.imul(a^a>>>7,a|61),(a^a>>>14)>>>0}nextFloat(){return this.next()/4294967295}nextInt(a,t){return Math.floor(this.nextFloat()*(t-a+1))+a}choice(a){return a[this.nextInt(0,a.length-1)]}shuffle(a){for(let t=a.length-1;t>0;t--){let e=this.nextInt(0,t);[a[t],a[e]]=[a[e],a[t]]}return a}chance(a){return this.nextFloat()<a}percentChance(a){return this.nextFloat()*100<a}},B=null});var ge={};Be(ge,{LOCAL_MONSTERS:()=>se,createEnemyFromTemplate:()=>fe,getAvailableCRs:()=>pe,getLocalMonstersByCR:()=>ne,getRandomLocalMonsters:()=>He});function ne(c){return se[c]??[]}function pe(){return Object.keys(se).map(Number).sort((c,a)=>c-a)}function fe(c){return{...c,id:`${c.id}-${crypto.randomUUID().slice(0,8)}`,maxHealth:c.health}}function He(c,a=1,t){let e=ne(c);if(e.length===0){let s=pe().reduce((o,i)=>Math.abs(i-c)<Math.abs(o-c)?i:o),r=ne(s);return r.length===0?[]:he(r,a,t)}return he(e,a,t)}function he(c,a,t){let e=[];for(let n=0;n<a&&c.length>0;n++){let s=t?t.nextInt(0,c.length-1):Math.floor(Math.random()*c.length);e.push(fe(c[s]))}return e}var se,ye=te(()=>{"use strict";re();se={0:[{id:"rat",name:"Giant Rat",health:7,attackPower:2,defense:10,experience:10,challengeRating:0,type:"beast",speed:30},{id:"bat",name:"Giant Bat",health:5,attackPower:2,defense:12,experience:10,challengeRating:0,type:"beast",speed:60},{id:"spider",name:"Giant Spider",health:4,attackPower:2,defense:10,experience:10,challengeRating:0,type:"beast",speed:30}],.125:[{id:"bandit",name:"Bandit",health:11,attackPower:3,defense:12,experience:25,challengeRating:.125,type:"humanoid",speed:30},{id:"cultist",name:"Cultist",health:9,attackPower:2,defense:12,experience:25,challengeRating:.125,type:"humanoid",speed:30},{id:"kobold",name:"Kobold",health:5,attackPower:4,defense:12,experience:25,challengeRating:.125,type:"humanoid",speed:30}],.25:[{id:"goblin",name:"Goblin",health:7,attackPower:4,defense:15,experience:50,challengeRating:.25,type:"humanoid",speed:30},{id:"skeleton",name:"Skeleton",health:13,attackPower:4,defense:13,experience:50,challengeRating:.25,type:"undead",speed:30},{id:"zombie",name:"Zombie",health:22,attackPower:3,defense:8,experience:50,challengeRating:.25,type:"undead",speed:20},{id:"wolf",name:"Wolf",health:11,attackPower:4,defense:13,experience:50,challengeRating:.25,type:"beast",speed:40}],.5:[{id:"orc",name:"Orc",health:15,attackPower:5,defense:13,experience:100,challengeRating:.5,type:"humanoid",speed:30},{id:"hobgoblin",name:"Hobgoblin",health:11,attackPower:3,defense:18,experience:100,challengeRating:.5,type:"humanoid",speed:30},{id:"shadow",name:"Shadow",health:16,attackPower:4,defense:12,experience:100,challengeRating:.5,type:"undead",speed:40},{id:"worg",name:"Worg",health:26,attackPower:5,defense:13,experience:100,challengeRating:.5,type:"monstrosity",speed:50}],1:[{id:"bugbear",name:"Bugbear",health:27,attackPower:4,defense:16,experience:200,challengeRating:1,type:"humanoid",speed:30},{id:"ghoul",name:"Ghoul",health:22,attackPower:4,defense:12,experience:200,challengeRating:1,type:"undead",speed:30},{id:"specter",name:"Specter",health:22,attackPower:4,defense:12,experience:200,challengeRating:1,type:"undead",speed:50},{id:"dire-wolf",name:"Dire Wolf",health:37,attackPower:5,defense:14,experience:200,challengeRating:1,type:"beast",speed:50}],2:[{id:"ogre",name:"Ogre",health:59,attackPower:6,defense:11,experience:450,challengeRating:2,type:"giant",speed:40},{id:"gargoyle",name:"Gargoyle",health:52,attackPower:4,defense:15,experience:450,challengeRating:2,type:"elemental",speed:30},{id:"ghast",name:"Ghast",health:36,attackPower:5,defense:13,experience:450,challengeRating:2,type:"undead",speed:30},{id:"mimic",name:"Mimic",health:58,attackPower:5,defense:12,experience:450,challengeRating:2,type:"monstrosity",speed:15}],3:[{id:"owlbear",name:"Owlbear",health:59,attackPower:7,defense:13,experience:700,challengeRating:3,type:"monstrosity",speed:40},{id:"mummy",name:"Mummy",health:58,attackPower:5,defense:11,experience:700,challengeRating:3,type:"undead",speed:20},{id:"werewolf",name:"Werewolf",health:58,attackPower:4,defense:12,experience:700,challengeRating:3,type:"humanoid",speed:40},{id:"hell-hound",name:"Hell Hound",health:45,attackPower:5,defense:15,experience:700,challengeRating:3,type:"fiend",speed:50}],4:[{id:"ettin",name:"Ettin",health:85,attackPower:7,defense:12,experience:1100,challengeRating:4,type:"giant",speed:40},{id:"ghost",name:"Ghost",health:45,attackPower:5,defense:11,experience:1100,challengeRating:4,type:"undead",speed:40},{id:"flameskull",name:"Flameskull",health:40,attackPower:5,defense:13,experience:1100,challengeRating:4,type:"undead",speed:40}],5:[{id:"troll",name:"Troll",health:84,attackPower:7,defense:15,experience:1800,challengeRating:5,type:"giant",speed:30},{id:"wraith",name:"Wraith",health:67,attackPower:6,defense:13,experience:1800,challengeRating:5,type:"undead",speed:60},{id:"salamander",name:"Salamander",health:90,attackPower:7,defense:15,experience:1800,challengeRating:5,type:"elemental",speed:30}],6:[{id:"chimera",name:"Chimera",health:114,attackPower:6,defense:14,experience:2300,challengeRating:6,type:"monstrosity",speed:30},{id:"cyclops",name:"Cyclops",health:138,attackPower:9,defense:14,experience:2300,challengeRating:6,type:"giant",speed:30},{id:"wyvern",name:"Wyvern",health:110,attackPower:7,defense:13,experience:2300,challengeRating:6,type:"dragon",speed:80}],7:[{id:"stone-giant",name:"Stone Giant",health:126,attackPower:9,defense:17,experience:2900,challengeRating:7,type:"giant",speed:40},{id:"oni",name:"Oni",health:110,attackPower:7,defense:16,experience:2900,challengeRating:7,type:"giant",speed:30}],8:[{id:"frost-giant",name:"Frost Giant",health:138,attackPower:8,defense:15,experience:3900,challengeRating:8,type:"giant",speed:40},{id:"hydra",name:"Hydra",health:172,attackPower:8,defense:15,experience:3900,challengeRating:8,type:"monstrosity",speed:30}],9:[{id:"fire-giant",name:"Fire Giant",health:162,attackPower:11,defense:18,experience:5e3,challengeRating:9,type:"giant",speed:30},{id:"treant",name:"Treant",health:138,attackPower:6,defense:16,experience:5e3,challengeRating:9,type:"plant",speed:30}],10:[{id:"aboleth",name:"Aboleth",health:135,attackPower:9,defense:17,experience:5900,challengeRating:10,type:"aberration",speed:40},{id:"stone-golem",name:"Stone Golem",health:178,attackPower:10,defense:17,experience:5900,challengeRating:10,type:"construct",speed:30}],11:[{id:"remorhaz",name:"Remorhaz",health:195,attackPower:11,defense:17,experience:7200,challengeRating:11,type:"monstrosity",speed:30},{id:"behir",name:"Behir",health:168,attackPower:10,defense:17,experience:7200,challengeRating:11,type:"monstrosity",speed:50}],12:[{id:"archmage",name:"Archmage",health:99,attackPower:6,defense:12,experience:8400,challengeRating:12,type:"humanoid",speed:30}],13:[{id:"beholder",name:"Beholder",health:180,attackPower:4,defense:18,experience:1e4,challengeRating:13,type:"aberration",speed:20},{id:"adult-white-dragon",name:"Adult White Dragon",health:200,attackPower:11,defense:18,experience:1e4,challengeRating:13,type:"dragon",speed:80}],14:[{id:"adult-black-dragon",name:"Adult Black Dragon",health:195,attackPower:11,defense:19,experience:11500,challengeRating:14,type:"dragon",speed:80}],15:[{id:"adult-green-dragon",name:"Adult Green Dragon",health:207,attackPower:11,defense:19,experience:13e3,challengeRating:15,type:"dragon",speed:80},{id:"purple-worm",name:"Purple Worm",health:247,attackPower:14,defense:18,experience:13e3,challengeRating:15,type:"monstrosity",speed:50}],16:[{id:"adult-blue-dragon",name:"Adult Blue Dragon",health:225,attackPower:12,defense:19,experience:15e3,challengeRating:16,type:"dragon",speed:80},{id:"iron-golem",name:"Iron Golem",health:210,attackPower:14,defense:20,experience:15e3,challengeRating:16,type:"construct",speed:30}],17:[{id:"adult-red-dragon",name:"Adult Red Dragon",health:256,attackPower:14,defense:19,experience:18e3,challengeRating:17,type:"dragon",speed:80},{id:"death-knight",name:"Death Knight",health:180,attackPower:11,defense:20,experience:18e3,challengeRating:17,type:"undead",speed:30}],18:[{id:"demilich",name:"Demilich",health:80,attackPower:6,defense:20,experience:2e4,challengeRating:18,type:"undead",speed:30}],19:[{id:"balor",name:"Balor",health:262,attackPower:14,defense:19,experience:22e3,challengeRating:19,type:"fiend",speed:40}],20:[{id:"ancient-white-dragon",name:"Ancient White Dragon",health:333,attackPower:14,defense:20,experience:25e3,challengeRating:20,type:"dragon",speed:80},{id:"pit-fiend",name:"Pit Fiend",health:300,attackPower:14,defense:19,experience:25e3,challengeRating:20,type:"fiend",speed:30}]}});function be(c){return new Promise(a=>setTimeout(a,c))}var w,V,re=te(()=>{"use strict";v();w=class extends Error{constructor(t,e,n){super(t);this.statusCode=e;this.monsterName=n;this.name="MonsterAPIError"}};V=class{static{this.BASE_URL="https://www.dnd5eapi.co/api/2014/monsters"}static{this.REQUEST_DELAY_MS=100}static{this.monsterCache=new Map}static{this.crCache=new Map}static{this.crNameListCache=new Map}static clearCache(){this.monsterCache.clear(),this.crCache.clear(),this.crNameListCache.clear()}static async getMonsterByName(a){let t=a.toLowerCase().replace(/\s+/g,"-"),e=this.monsterCache.get(t);if(e)return e;let n;try{n=await fetch(`${this.BASE_URL}/${t}`)}catch(o){throw new w(`Network error fetching monster: ${o instanceof Error?o.message:"Unknown error"}`,void 0,a)}if(!n.ok)throw new w(`Monster '${a}' not found or API error`,n.status,a);let s;try{s=await n.json()}catch{throw new w("Failed to parse API response",n.status,a)}let r=this.mapToEnemy(s);return this.monsterCache.set(t,r),r}static{this.API_BASE="https://www.dnd5eapi.co"}static mapToEnemy(a){let t=a.armor_class?.[0]?.value??10,e=a.actions?.find(i=>i.attack_bonus!==void 0)?.attack_bonus??0,n=a.speed?.walk??"30 ft.",s=parseInt(n,10)||30,r=this.mapEnemyType(a.type),o=a.image?`${this.API_BASE}${a.image}`:void 0;return{id:a.index,name:a.name,health:a.hit_points,maxHealth:a.hit_points,attackPower:e,defense:t,experience:a.xp??0,challengeRating:a.challenge_rating??0,type:r,speed:s,imageUrl:o}}static mapEnemyType(a){return{aberration:"aberration",beast:"beast",celestial:"celestial",construct:"construct",dragon:"dragon",elemental:"elemental",fey:"fey",fiend:"fiend",giant:"giant",humanoid:"humanoid",monstrosity:"monstrosity",ooze:"ooze",plant:"plant",undead:"undead"}[a.toLowerCase()]??"monstrosity"}static async getMonsters(a){let t=[];for(let e of a){let n=e.toLowerCase().replace(/\s+/g,"-");this.monsterCache.has(n)||await be(this.REQUEST_DELAY_MS);let s=await this.getMonsterByName(e);t.push(s)}return t}static async getMonsterNamesByCR(a){let t=this.crNameListCache.get(a);if(t)return t;let e;try{await be(this.REQUEST_DELAY_MS),e=await fetch(`${this.BASE_URL}?challenge_rating=${a}`)}catch(r){throw new w(`Network error fetching monsters by CR: ${r instanceof Error?r.message:"Unknown error"}`)}if(!e.ok)throw new w(`Failed to fetch monsters with CR ${a}`,e.status);let n;try{n=await e.json()}catch{throw new w("Failed to parse monster list response",e.status)}let s=n.results.map(r=>r.index);return this.crNameListCache.set(a,s),s}static async getMonstersByCR(a){let t=this.crCache.get(a);if(t)return t;let e=await this.getMonsterNamesByCR(a),n=await this.getMonsters(e);return this.crCache.set(a,n),n}static async getMonstersByCRRange(a,t){let n=[0,.125,.25,.5,...Array.from({length:30},(r,o)=>o+1)].filter(r=>r>=a&&r<=t),s=[];for(let r of n){let o=await this.getMonstersByCR(r);s.push(...o)}return s}static async getRandomMonstersByCR(a,t=1){try{let e=await this.getMonsterNamesByCR(a);if(e.length===0)return this.getRandomMonstersFromLocalDB(a,t);let n=[],s=y()?g():null;for(let o=0;o<t&&e.length>0;o++){let i=s?s.nextInt(0,e.length-1):Math.floor(Math.random()*e.length);n.push(e[i])}return(await this.getMonsters(n)).map(o=>({...o,id:`${o.id}-${crypto.randomUUID().slice(0,8)}`}))}catch(e){return console.warn("Monster API failed, using local fallback:",e),this.getRandomMonstersFromLocalDB(a,t)}}static getRandomMonstersFromLocalDB(a,t){let{getRandomLocalMonsters:e}=(ye(),Ge(ge)),n=y()?g():null;return e(a,t,n)}static async getMonstersForLevel(a,t){let e={1:[0,.5],2:[.25,1],3:[.5,2],4:[1,3],5:[2,4],6:[2,5],7:[3,6],8:[4,7],9:[4,8],10:[5,9],11:[6,10],12:[7,11],13:[8,12],14:[9,13],15:[10,14],16:[11,16],17:[12,17],18:[13,18],19:[14,19],20:[15,20]},n=Math.min(Math.max(a,1),20),[s,r]=e[n],o=await this.getMonstersByCRRange(s,r);if(o.length===0)return[];let i=t??Math.min(1+Math.floor(a/5),4),l=[],m=y()?g():null;for(let d=0;d<i&&o.length>0;d++){let u=m?m.nextInt(0,o.length-1):Math.floor(Math.random()*o.length),f={...o[u]};f.id=`${f.id}-${crypto.randomUUID().slice(0,8)}`,l.push(f)}return l}}});re();v();function Ee(c){let a=c.match(/(\d+)d(\d+)(?:\s*\+\s*(\d+))?/);if(!a)return 0;let t=parseInt(a[1],10),e=parseInt(a[2],10),n=a[3]?parseInt(a[3],10):0;return t*((e+1)/2)+n}function D(c,a){let t=c.match(/(\d+)d(\d+)(?:\s*\+\s*(\d+))?/);if(!t)return 0;let e=parseInt(t[1],10),n=parseInt(t[2],10),s=t[3]?parseInt(t[3],10):0,r=a??(y()?g():null),o=s;for(let i=0;i<e;i++)r?o+=r.nextInt(1,n):o+=Math.floor(Math.random()*n)+1;return o}function p(c){return{...{slot:Ue(c.type),rarity:"common",value:0,weight:0},...c}}function Ue(c){switch(c){case"weapon":return"weapon";case"armor":return"armor";case"accessory":return"accessory";case"consumable":return"consumable";case"treasure":return"none";default:return"none"}}v();var ze=[p({id:"dagger",name:"Dagger",type:"weapon",rarity:"common",value:2,weight:1,description:"A simple dagger, quick but weak.",damage:{dice:"1d4",type:"piercing"},weaponProperties:["Finesse","Light","Thrown"],bonuses:{speed:2}}),p({id:"shortsword",name:"Shortsword",type:"weapon",rarity:"common",value:10,weight:2,description:"A reliable short blade.",damage:{dice:"1d6",type:"slashing"},weaponProperties:["Finesse","Light"]}),p({id:"longsword",name:"Longsword",type:"weapon",rarity:"common",value:15,weight:3,description:"A versatile blade favored by fighters.",damage:{dice:"1d8",type:"slashing"},twoHandedDamage:{dice:"1d10",type:"slashing"},weaponProperties:["Versatile"]}),p({id:"greataxe",name:"Greataxe",type:"weapon",rarity:"common",value:30,weight:7,description:"A massive axe requiring two hands.",damage:{dice:"1d12",type:"slashing"},weaponProperties:["Heavy","Two-Handed"],bonuses:{attack:1}}),p({id:"staff",name:"Wooden Staff",type:"weapon",rarity:"common",value:5,weight:4,description:"A simple wooden staff, good for channeling magic.",damage:{dice:"1d6",type:"bludgeoning"},weaponProperties:["Versatile"],bonuses:{maxMana:10}}),p({id:"silver-sword",name:"Silver Sword",type:"weapon",rarity:"uncommon",value:100,weight:3,description:"A blade of pure silver, effective against undead.",damage:{dice:"1d8",type:"slashing"},bonuses:{attack:2}}),p({id:"vampiric-dagger",name:"Vampiric Dagger",type:"weapon",rarity:"uncommon",value:150,weight:1,description:"A cursed blade that drains life from enemies.",damage:{dice:"1d4",type:"piercing"},onHit:{chance:25,type:"lifesteal",value:5},bonuses:{speed:2}}),p({id:"arcane-staff",name:"Arcane Staff",type:"weapon",rarity:"uncommon",value:200,weight:4,description:"A staff imbued with arcane energy.",damage:{dice:"1d6",type:"magic"},bonuses:{maxMana:25,critChance:3}}),p({id:"flame-tongue",name:"Flame Tongue",type:"weapon",rarity:"rare",value:500,weight:3,description:"A sword wreathed in magical flames.",damage:{dice:"1d8",type:"slashing"},onHit:{chance:100,type:"burn",value:5,duration:2},bonuses:{attack:3}}),p({id:"frost-brand",name:"Frost Brand",type:"weapon",rarity:"rare",value:500,weight:3,description:"A blade of eternal ice that chills enemies to the bone.",damage:{dice:"1d8",type:"slashing"},onHit:{chance:30,type:"freeze",duration:1},bonuses:{attack:2,defense:2}}),p({id:"staff-of-power",name:"Staff of Power",type:"weapon",rarity:"rare",value:750,weight:4,description:"A powerful staff crackling with arcane energy.",damage:{dice:"1d8",type:"magic"},bonuses:{maxMana:50,attack:2,critMultiplier:.25},grantedAbility:{id:"arcane-burst",name:"Arcane Burst",description:"Release a burst of arcane energy dealing damage to all enemies.",manaCost:25,cooldown:4,currentCooldown:0,damage:20,damageType:"magic",isAoe:!0}}),p({id:"vorpal-sword",name:"Vorpal Sword",type:"weapon",rarity:"very_rare",value:2e3,weight:3,description:"A legendary blade that can sever heads with a single strike.",damage:{dice:"2d6",type:"slashing"},bonuses:{attack:5,critChance:10,critMultiplier:.5}}),p({id:"staff-of-the-magi",name:"Staff of the Magi",type:"weapon",rarity:"very_rare",value:2500,weight:4,description:"The ultimate staff for any spellcaster.",damage:{dice:"1d10",type:"magic"},bonuses:{maxMana:100,attack:4,maxHealth:20},grantedAbility:{id:"spell-absorption",name:"Spell Absorption",description:"Absorb incoming magic damage and convert it to mana.",manaCost:0,cooldown:5,currentCooldown:0,effect:"magic_immunity"}}),p({id:"soul-reaver",name:"Soul Reaver",type:"weapon",rarity:"legendary",value:1e4,weight:4,description:"A blade forged from the souls of fallen warriors.",damage:{dice:"2d8",type:"necrotic"},onHit:{chance:50,type:"lifesteal",value:15},bonuses:{attack:8,maxHealth:30,critChance:15},grantedAbility:{id:"soul-drain",name:"Soul Drain",description:"Drain the soul of an enemy, dealing massive damage and healing yourself.",manaCost:40,cooldown:6,currentCooldown:0,damage:50,damageType:"necrotic",healing:25}})],qe=[p({id:"leather-armor",name:"Leather Armor",type:"armor",rarity:"common",value:10,weight:10,description:"Light armor made of leather.",armorClass:11,dexBonus:!0}),p({id:"chain-shirt",name:"Chain Shirt",type:"armor",rarity:"common",value:50,weight:20,description:"A shirt of interlocking metal rings.",armorClass:13,dexBonus:!0,maxDexBonus:2}),p({id:"chain-mail",name:"Chain Mail",type:"armor",rarity:"common",value:75,weight:55,description:"Heavy armor of interlocking metal rings.",armorClass:16,dexBonus:!1,strengthRequirement:13,stealthDisadvantage:!0}),p({id:"robes",name:"Cloth Robes",type:"armor",rarity:"common",value:5,weight:3,description:"Simple cloth robes, offering little protection.",armorClass:10,dexBonus:!0,bonuses:{maxMana:15}}),p({id:"scale-mail-plus",name:"Scale Mail +1",type:"armor",rarity:"uncommon",value:200,weight:45,description:"Enchanted scale armor providing extra protection.",armorClass:15,dexBonus:!0,maxDexBonus:2,bonuses:{defense:1}}),p({id:"mithral-chain",name:"Mithral Chain Shirt",type:"armor",rarity:"uncommon",value:300,weight:10,description:"Lightweight chain made of mithral.",armorClass:13,dexBonus:!0,bonuses:{speed:5}}),p({id:"arcane-robes",name:"Arcane Robes",type:"armor",rarity:"uncommon",value:250,weight:3,description:"Robes woven with arcane threads.",armorClass:11,dexBonus:!0,bonuses:{maxMana:30,critChance:2}}),p({id:"plate-of-fortitude",name:"Plate of Fortitude",type:"armor",rarity:"rare",value:1500,weight:65,description:"Heavy plate armor that bolsters the wearer's vitality.",armorClass:18,dexBonus:!1,strengthRequirement:15,stealthDisadvantage:!0,bonuses:{maxHealth:30,defense:3}}),p({id:"shadow-leather",name:"Shadow Leather",type:"armor",rarity:"rare",value:800,weight:8,description:"Armor that seems to absorb light.",armorClass:13,dexBonus:!0,bonuses:{speed:10,critChance:5}}),p({id:"robes-of-the-archmagi",name:"Robes of the Archmagi",type:"armor",rarity:"rare",value:1e3,weight:3,description:"Legendary robes worn by powerful mages.",armorClass:13,dexBonus:!0,bonuses:{maxMana:50,defense:2,critMultiplier:.2}}),p({id:"armor-of-invulnerability",name:"Armor of Invulnerability",type:"armor",rarity:"legendary",value:15e3,weight:65,description:"Legendary armor that renders the wearer nearly invincible.",armorClass:20,dexBonus:!1,strengthRequirement:15,bonuses:{maxHealth:50,defense:10},grantedAbility:{id:"invulnerability",name:"Invulnerability",description:"Become immune to all damage for 1 turn.",manaCost:50,cooldown:10,currentCooldown:0,effect:"invulnerable"}})],Ye=[p({id:"ring-of-protection",name:"Ring of Protection",type:"accessory",rarity:"common",value:50,weight:0,description:"A simple ring that offers minor protection.",bonuses:{defense:1}}),p({id:"amulet-of-health",name:"Amulet of Health",type:"accessory",rarity:"common",value:50,weight:0,description:"An amulet that bolsters vitality.",bonuses:{maxHealth:10}}),p({id:"ring-of-mana",name:"Ring of Mana",type:"accessory",rarity:"common",value:50,weight:0,description:"A ring that expands the wearer's mana pool.",bonuses:{maxMana:15}}),p({id:"boots-of-speed",name:"Boots of Speed",type:"accessory",rarity:"uncommon",value:200,weight:1,description:"Enchanted boots that quicken the wearer.",bonuses:{speed:10}}),p({id:"cloak-of-protection",name:"Cloak of Protection",type:"accessory",rarity:"uncommon",value:250,weight:1,description:"A magical cloak that deflects attacks.",bonuses:{defense:2,maxHealth:10}}),p({id:"ring-of-precision",name:"Ring of Precision",type:"accessory",rarity:"uncommon",value:200,weight:0,description:"A ring that sharpens the wearer's strikes.",bonuses:{critChance:5,attack:1}}),p({id:"amulet-of-fireball",name:"Amulet of Fireball",type:"accessory",rarity:"rare",value:1e3,weight:0,description:"An amulet that grants the power to cast Fireball.",bonuses:{maxMana:20},grantedAbility:{id:"fireball",name:"Fireball",description:"Hurl a ball of fire at all enemies.",manaCost:30,cooldown:5,currentCooldown:0,damage:30,damageType:"fire",isAoe:!0}}),p({id:"ring-of-vampirism",name:"Ring of Vampirism",type:"accessory",rarity:"rare",value:800,weight:0,description:"A cursed ring that drains life with each attack.",onHit:{chance:20,type:"lifesteal",value:10},bonuses:{attack:2}}),p({id:"belt-of-giant-strength",name:"Belt of Giant Strength",type:"accessory",rarity:"rare",value:1200,weight:1,description:"A belt that grants the strength of a giant.",bonuses:{attack:5,maxHealth:20}}),p({id:"ring-of-three-wishes",name:"Ring of Three Wishes",type:"accessory",rarity:"legendary",value:5e4,weight:0,description:"A legendary ring containing three powerful wishes.",bonuses:{maxHealth:30,maxMana:30,attack:3,defense:3},grantedAbility:{id:"wish",name:"Wish",description:"Fully restore health and mana, and reset all cooldowns.",manaCost:0,cooldown:99,currentCooldown:0,healing:999,effect:"full_restore"}})],Ve=[p({id:"potion-of-healing",name:"Potion of Healing",type:"consumable",rarity:"common",value:50,weight:.5,description:"A red potion that restores health.",consumeEffect:{healing:{dice:"2d4",bonus:2}}}),p({id:"potion-of-greater-healing",name:"Potion of Greater Healing",type:"consumable",rarity:"uncommon",value:100,weight:.5,description:"A vibrant red potion that restores significant health.",consumeEffect:{healing:{dice:"4d4",bonus:4}}}),p({id:"potion-of-superior-healing",name:"Potion of Superior Healing",type:"consumable",rarity:"rare",value:500,weight:.5,description:"A brilliant red potion that restores great health.",consumeEffect:{healing:{dice:"8d4",bonus:8}}}),p({id:"potion-of-mana",name:"Potion of Mana",type:"consumable",rarity:"common",value:50,weight:.5,description:"A blue potion that restores mana.",consumeEffect:{manaRestore:25}}),p({id:"potion-of-greater-mana",name:"Potion of Greater Mana",type:"consumable",rarity:"uncommon",value:100,weight:.5,description:"A vibrant blue potion that restores significant mana.",consumeEffect:{manaRestore:50}}),p({id:"potion-of-strength",name:"Potion of Strength",type:"consumable",rarity:"uncommon",value:150,weight:.5,description:"A potion that temporarily increases attack power.",consumeEffect:{buffDuration:5,buff:{attack:5}}}),p({id:"potion-of-iron-skin",name:"Potion of Iron Skin",type:"consumable",rarity:"uncommon",value:150,weight:.5,description:"A potion that temporarily increases defense.",consumeEffect:{buffDuration:5,buff:{defense:5}}}),p({id:"elixir-of-heroism",name:"Elixir of Heroism",type:"consumable",rarity:"rare",value:500,weight:.5,description:"A powerful elixir that enhances all abilities.",consumeEffect:{buffDuration:3,buff:{attack:5,defense:3,critChance:10,speed:5}}})],We=[p({id:"gold-coins",name:"Gold Coins",type:"treasure",slot:"none",rarity:"common",value:1,weight:.02,description:"Shiny gold coins.",stackable:!0,quantity:1}),p({id:"ruby",name:"Ruby",type:"treasure",slot:"none",rarity:"uncommon",value:100,weight:0,description:"A brilliant red gemstone."}),p({id:"sapphire",name:"Sapphire",type:"treasure",slot:"none",rarity:"uncommon",value:100,weight:0,description:"A deep blue gemstone."}),p({id:"emerald",name:"Emerald",type:"treasure",slot:"none",rarity:"rare",value:500,weight:0,description:"A vivid green gemstone."}),p({id:"diamond",name:"Diamond",type:"treasure",slot:"none",rarity:"very_rare",value:1e3,weight:0,description:"A flawless diamond."})],Ze=[...ze,...qe,...Ye,...Ve,...We];function I(c,a,t){let e=t??(y()?g():null),n=Ze;if(c&&(n=n.filter(r=>r.type===c)),a){let r=["common","uncommon","rare","very_rare","legendary"],o=r.indexOf(a);n=n.filter(i=>r.indexOf(i.rarity)<=o)}let s=[];for(let r of n){let o=r.rarity==="common"?10:r.rarity==="uncommon"?5:r.rarity==="rare"?2:r.rarity==="very_rare"?1:.5;for(let i=0;i<o;i++)s.push(r)}return e?e.choice(s):s[Math.floor(Math.random()*s.length)]}function T(c,a,t=!1){let e=a??(y()?g():null),n=[],s;c>=15?s="legendary":c>=10?s="very_rare":c>=5?s="rare":c>=3?s="uncommon":s="common",n.push(I("consumable",s,e??void 0));let r=.5+c*.03;if(t||(e?e.chance(r):Math.random()<r)){let i=["weapon","armor","accessory"],l=e?e.choice(i):i[Math.floor(Math.random()*i.length)];n.push(I(l,s,e??void 0))}if(c>=5){let i=.1+c*.02;if(e?e.chance(i):Math.random()<i){let m=["weapon","armor","accessory"],d=e?e.choice(m):m[Math.floor(Math.random()*m.length)];n.push(I(d,s,e??void 0))}}return n}function A(c){return{...c,id:`${c.id}-${crypto.randomUUID().slice(0,8)}`}}function ve(c,a){let t=a??(y()?g():null),e=[],n;c>=15?n="very_rare":c>=10?n="rare":c>=5?n="uncommon":n="common";let s=1.5,r=t?t.nextInt(2,3):Math.floor(Math.random()*2)+2;for(let m=0;m<r;m++){let d=A(I("consumable",n,t??void 0));e.push({item:d,buyPrice:Math.floor(d.value*s)})}let o=t?t.nextInt(1,2):Math.floor(Math.random()*2)+1;for(let m=0;m<o;m++){let d=A(I("weapon",n,t??void 0));e.push({item:d,buyPrice:Math.floor(d.value*s)})}let i=t?t.nextInt(1,2):Math.floor(Math.random()*2)+1;for(let m=0;m<i;m++){let d=A(I("armor",n,t??void 0));e.push({item:d,buyPrice:Math.floor(d.value*s)})}if(t?t.chance(.6):Math.random()<.6){let m=A(I("accessory",n,t??void 0));e.push({item:m,buyPrice:Math.floor(m.value*s)})}return e}function G(c){return Math.floor(c.value*.5)}v();v();var Ke={chest:["Wooden Chest","Iron Chest","Ornate Chest","Ancient Chest"],lever:["Rusty Lever","Stone Lever","Golden Lever"],altar:["Stone Altar","Dark Altar","Blessed Altar","Ancient Shrine"],trap:["Spike Trap","Poison Dart Trap","Fire Trap","Pit Trap"],npc:["Wandering Merchant","Lost Adventurer","Mysterious Figure"]},Xe={spike:["Spike Trap","Pit Trap","Blade Trap","Crushing Wall"],poison:["Poison Dart Trap","Venomous Needle","Toxic Gas Vent","Serpent Trap"],frost:["Frost Trap","Ice Shard Trap","Freezing Glyph","Cryogenic Vent"],fire:["Fire Trap","Flame Jet","Inferno Glyph","Lava Pit"],stun:["Lightning Trap","Thunder Rune","Shock Plate","Static Glyph"],teleport:["Teleportation Circle","Displacement Trap","Warp Rune"],gold_drain:["Cursed Chest","Greed Trap","Gold Siphon"],alarm:["Alarm Trap","Summoning Circle","Warning Glyph","Sentry Rune"]};function je(c){let a=["spike"];return c>=2&&a.push("poison"),c>=3&&a.push("frost"),c>=4&&a.push("fire"),c>=5&&a.push("stun"),c>=7&&a.push("gold_drain"),c>=8&&a.push("alarm"),c>=10&&a.push("teleport"),a}function Qe(c,a){let t=Xe[c];return a?a.choice(t):t[Math.floor(Math.random()*t.length)]}function S(c,a){let t=y()?g():null,e=Ke[c],n=t?t.choice(e):e[Math.floor(Math.random()*e.length)],s={id:crypto.randomUUID(),type:c,name:n,used:!1};switch(c){case"chest":s.contents=T(a).map(o=>A(o)),s.gold=Math.floor((t?t.nextInt(10,50):Math.random()*40+10)*a);break;case"trap":{let o=je(a);s.trapType=t?t.choice(o):o[Math.floor(Math.random()*o.length)],s.damage=Math.floor(5+a*2+(t?t.nextInt(0,a):Math.random()*a)),s.disarmed=!1,s.disarmDC=Math.min(20,8+Math.floor(a*.6));let i=.3+a*.02;s.hidden=t?t.chance(i):Math.random()<i,s.detected=!s.hidden,s.name=Qe(s.trapType,t);break}case"altar":(t?t.chance(.3):Math.random()<.3)&&(s.contents=T(a+1).map(o=>A(o)));break}return s}function W(c){if(c.used&&c.type!=="npc")return{message:`The ${c.name} has already been used.`,consumed:!1};switch(c.type){case"chest":{c.used=!0;let a=[];if(c.contents&&c.contents.length>0){let e=c.contents.map(n=>n.name);if(e.length===1)a.push(e[0]);else if(e.length===2)a.push(`${e[0]} and ${e[1]}`);else{let n=e.pop();a.push(`${e.join(", ")}, and ${n}`)}}c.gold&&c.gold>0&&a.push(`${c.gold} gold`);let t=a.length>0?a.join(" and "):"nothing";return{message:`You open the ${c.name} and find ${t}!`,items:c.contents,gold:c.gold,consumed:!0}}case"trap":return c.disarmed?{message:`The ${c.name} has been disarmed.`,consumed:!1}:(c.used=!0,Je(c));case"altar":{if(c.used=!0,c.contents&&c.contents.length>0){let e=c.contents.map(n=>n.name).join(", ");return{message:`You pray at the ${c.name} and find offerings: ${e}.`,items:c.contents,consumed:!0}}let a=y()?g():null,t=a?a.nextFloat():Math.random();if(t<.4){let e=["attack","defense","speed"],n=e[Math.floor((a?a.nextFloat():Math.random())*e.length)],s=a?a.nextInt(2,5):Math.floor(Math.random()*3)+2,r=a?a.nextInt(5,10):Math.floor(Math.random()*5)+5;return{message:`The ${c.name} bestows a blessing upon you! +${s} ${n} for ${r} turns.`,statBonus:{[n]:s},duration:r,consumed:!0}}else if(t<.7){let e=a?a.nextInt(15,40):Math.floor(Math.random()*25+15);return{message:`The ${c.name} glows warmly. You feel restored.`,healing:e,consumed:!0}}else if(t<.85){let e=a?a.nextInt(20,50):Math.floor(Math.random()*30+20);return{message:`You find gold offerings at the ${c.name}.`,gold:e,consumed:!0}}else{let e=a?a.nextInt(8,20):Math.floor(Math.random()*12+8);return{message:`Dark energy surges from the ${c.name}!`,damage:e,consumed:!0}}}case"lever":return c.used=!0,{message:`You pull the ${c.name}. You hear a distant rumbling...`,consumed:!0};case"npc":return{message:`The ${c.name} greets you.`,consumed:!1};default:return{message:"Nothing happens.",consumed:!1}}}function Je(c){let a=y()?g():null,t=c.trapType??"spike",e={message:`You trigger the ${c.name}!`,damage:c.damage,consumed:!0};switch(t){case"spike":e.message=`You trigger the ${c.name}! Sharp spikes pierce your flesh for ${c.damage} damage!`;break;case"poison":{let n=a?a.nextInt(3,6):Math.floor(Math.random()*3)+3,s=Math.floor((c.damage??10)/3);e.message=`You trigger the ${c.name}! Venomous darts strike you for ${c.damage} damage and poison courses through your veins!`,e.trapEffect={statusEffect:{type:"poison",duration:n,damagePerTurn:s}};break}case"frost":{let n=a?a.nextInt(2,4):Math.floor(Math.random()*2)+2;e.damage=Math.floor((c.damage??10)*.7),e.message=`You trigger the ${c.name}! Freezing cold blasts you for ${e.damage} damage and slows your movements!`,e.trapEffect={statusEffect:{type:"slow",duration:n,statReduction:3}};break}case"fire":{let n=a?a.nextInt(2,4):Math.floor(Math.random()*2)+2,s=Math.floor((c.damage??10)/4);e.damage=Math.floor((c.damage??10)*1.2),e.message=`You trigger the ${c.name}! Flames engulf you for ${e.damage} damage and you catch fire!`,e.trapEffect={statusEffect:{type:"burn",duration:n,damagePerTurn:s}};break}case"stun":{let n=a?a.nextInt(1,2):1;e.damage=Math.floor((c.damage??10)*.5),e.message=`You trigger the ${c.name}! Lightning courses through you for ${e.damage} damage and stuns you!`,e.trapEffect={statusEffect:{type:"stun",duration:n}};break}case"teleport":e.damage=0,e.message=`You trigger the ${c.name}! Reality warps around you and you find yourself elsewhere!`,e.trapEffect={teleport:!0};break;case"gold_drain":{let n=a?a.nextInt(20,100):Math.floor(Math.random()*80)+20;e.damage=Math.floor((c.damage??10)*.3),e.message=`You trigger the ${c.name}! A curse drains ${n} gold from your pouch!`,e.goldLost=n,e.trapEffect={goldLost:n};break}case"alarm":e.damage=0,e.message=`You trigger the ${c.name}! A loud alarm sounds and you hear footsteps approaching!`,e.trapEffect={alarmTriggered:!0};break}return e}v();v();var et=[{name:"Blessing of Strength",stat:"attack",value:5,duration:10,desc:"Your muscles surge with power!"},{name:"Iron Skin",stat:"defense",value:5,duration:10,desc:"Your skin hardens like iron!"},{name:"Swift Feet",stat:"speed",value:10,duration:10,desc:"You feel light as a feather!"},{name:"Arcane Infusion",stat:"maxMana",value:20,duration:15,desc:"Magical energy flows through you!"},{name:"Vitality Surge",stat:"maxHealth",value:30,duration:15,desc:"Life force courses through your veins!"},{name:"Lucky Charm",stat:"critChance",value:10,duration:10,desc:"Fortune smiles upon you!"}],tt=[{name:"Curse of Weakness",stat:"attack",value:-3,duration:8,desc:"A dark curse saps your strength..."},{name:"Brittle Bones",stat:"defense",value:-3,duration:8,desc:"Your defenses feel fragile..."},{name:"Sluggish Mind",stat:"speed",value:-5,duration:8,desc:"Your reactions slow..."},{name:"Mana Drain",stat:"maxMana",value:-10,duration:10,desc:"Your magical reserves diminish..."}],at=[{name:"Blade of the Fallen",description:"A sword that whispers of ancient battles",damage:{dice:"2d6",bonus:3,type:"slashing"},stats:{attack:4,critChance:5},rarity:"rare"},{name:"Thunderstrike Mace",description:"Crackles with barely contained lightning",damage:{dice:"1d10",bonus:4,type:"bludgeoning"},stats:{attack:5},rarity:"rare"},{name:"Shadowfang Dagger",description:"Seems to drink in the light around it",damage:{dice:"1d6",bonus:2,type:"piercing"},stats:{attack:2,speed:5,critChance:10},rarity:"rare"},{name:"Infernal Greataxe",description:"Burns with hellfire that never dies",damage:{dice:"2d8",bonus:5,type:"fire"},stats:{attack:6},rarity:"very_rare"}],nt=[{name:"Dragonscale Mail",description:"Forged from the scales of an ancient dragon",stats:{defense:6,maxHealth:20},rarity:"rare"},{name:"Cloak of Shadows",description:"Makes you harder to hit",stats:{defense:3,speed:8},rarity:"rare"},{name:"Platemail of the Guardian",description:"Heavy but nearly impenetrable",stats:{defense:8,speed:-2},rarity:"rare"},{name:"Robes of the Archmage",description:"Woven with threads of pure magic",stats:{defense:2,maxMana:30,mana:15},rarity:"very_rare"}],st=[{name:"Greater Healing Potion",description:"Restores a significant amount of health",healing:{dice:"4d4",bonus:8},rarity:"uncommon"},{name:"Elixir of Vitality",description:"Fully restores health and grants temporary vigor",healing:{dice:"6d6",bonus:10},buff:{maxHealth:20},buffDuration:5,rarity:"rare"},{name:"Potion of Giant Strength",description:"Grants immense strength for a time",buff:{attack:8},buffDuration:8,rarity:"rare"}],rt={altar:["You approach a mysterious altar glowing with ethereal light...","An ancient shrine pulses with unknown energy...","A weathered statue seems to watch you with knowing eyes..."],chest:["You discover a ornate chest hidden in the shadows...","A golden coffer sits atop a stone pedestal...","An ancient lockbox bears strange runes..."],spirit:["A ghostly figure materializes before you...","The air shimmers and a spectral form appears...","You sense a presence watching from beyond the veil..."]};function Ae(c){let a=y()?g():null,t=()=>a?a.nextFloat():Math.random(),e=m=>m[Math.floor(t()*m.length)],n=Math.min(c/40,.15),s=t(),r;s<.2+n?r="weapon":s<.35+n?r="armor":s<.5+n?r="potion":s<.65+n?r="buff":s<.75?r="gold":s<.85?r="heal":s<.92?r="debuff":r="damage";let o=ot(r,c,e),i=e(["altar","chest","spirit"]),l=e(rt[i]);return{id:crypto.randomUUID(),title:it(i),description:l,outcome:o}}function it(c){switch(c){case"altar":return"Mysterious Altar";case"chest":return"Hidden Treasure";case"spirit":return"Spectral Encounter"}}function ot(c,a,t){switch(c){case"buff":{let e=t(et),n=Math.floor(e.value*(1+a/20));return{type:"buff",name:e.name,description:e.desc,statBonus:{[e.stat]:n},duration:e.duration,isPositive:!0}}case"debuff":{let e=t(tt);return{type:"debuff",name:e.name,description:e.desc,statBonus:{[e.stat]:e.value},duration:e.duration,isPositive:!1}}case"weapon":{let e=t(at),n=p({id:`event-weapon-${crypto.randomUUID()}`,name:e.name,type:"weapon",slot:"weapon",rarity:e.rarity,value:100+a*20,description:e.description,damage:e.damage,bonuses:e.stats});return{type:"weapon",name:e.name,description:`You found ${e.name}! ${e.description}`,item:n,isPositive:!0}}case"armor":{let e=t(nt),n=p({id:`event-armor-${crypto.randomUUID()}`,name:e.name,type:"armor",slot:"armor",rarity:e.rarity,value:80+a*15,description:e.description,bonuses:e.stats});return{type:"armor",name:e.name,description:`You found ${e.name}! ${e.description}`,item:n,isPositive:!0}}case"potion":{let e=t(st),n=p({id:`event-potion-${crypto.randomUUID()}`,name:e.name,type:"consumable",slot:"consumable",rarity:e.rarity,value:50+a*5,description:e.description,consumeEffect:{healing:e.healing,buff:e.buff,buffDuration:e.buffDuration}});return{type:"potion",name:e.name,description:`You found ${e.name}! ${e.description}`,item:n,isPositive:!0}}case"gold":{let e=50+Math.floor(a*15*(.8+Math.random()*.4));return{type:"gold",name:"Gold Cache",description:`You discovered a hidden cache of ${e} gold!`,gold:e,isPositive:!0}}case"heal":return{type:"heal",name:"Healing Light",description:"A warm light washes over you, healing your wounds.",healthChange:.3+Math.random()*.2,isPositive:!0};case"damage":return{type:"damage",name:"Dark Curse",description:"A malevolent force strikes you!",healthChange:-(.1+Math.random()*.15),isPositive:!1}}}function Te(c){switch(c.type){case"buff":return`${c.name} - ${c.description} (+${Object.entries(c.statBonus||{}).map(([a,t])=>`${t} ${a}`).join(", ")} for ${c.duration} turns)`;case"debuff":return`${c.name} - ${c.description} (${Object.entries(c.statBonus||{}).map(([a,t])=>`${t} ${a}`).join(", ")} for ${c.duration} turns)`;case"weapon":case"armor":case"potion":return c.description;case"gold":return c.description;case"heal":return c.description;case"damage":return c.description;default:return c.description}}v();var Me=[{question:"I have cities, but no houses live there. I have mountains, but no trees grow there. I have water, but no fish swim there. What am I?",options:["A painting","A map","A dream","A mirror"],correctIndex:1,hint:"Adventurers use me to find their way."},{question:"The more you take, the more you leave behind. What am I?",options:["Memories","Footsteps","Breaths","Time"],correctIndex:1,hint:"Look down as you walk."},{question:"I speak without a mouth and hear without ears. I have no body, but I come alive with the wind. What am I?",options:["A ghost","An echo","A shadow","A whisper"],correctIndex:1,hint:"Shout in a canyon and you'll find me."},{question:"What has keys but no locks, space but no room, and you can enter but can't go inside?",options:["A keyboard","A piano","A treasure chest","A riddle"],correctIndex:0,hint:"Wizards use these to write their spells."},{question:"I am not alive, but I grow. I don't have lungs, but I need air. What am I?",options:["A crystal","Fire","A shadow","Moss"],correctIndex:1,hint:"Dragons breathe this."},{question:"What can travel around the world while staying in a corner?",options:["A spider","A stamp","A shadow","The wind"],correctIndex:1,hint:"Found on letters and parcels."},{question:"The more of me there is, the less you see. What am I?",options:["Fog","Darkness","Smoke","All of these"],correctIndex:3,hint:"Rogues love to hide in me."},{question:"I have hands but cannot clap. What am I?",options:["A statue","A clock","A tree","A puppet"],correctIndex:1,hint:"I tell you when it's time for adventure."}],x=["Fire","Water","Earth","Air","Light","Shadow"],ct=["\u{1F525}","\u{1F4A7}","\u{1F30D}","\u{1F4A8}","\u2728","\u{1F311}"];function lt(c){let a=y()?g():null,t=()=>a?a.nextFloat():Math.random(),e=(h,b)=>Math.floor(t()*(b-h+1))+h,n=10+c*2,s=e(0,2),r,o,i,l,m;switch(s){case 0:r=e(5,n),o=e(5,n),i=r+o,l=`A warrior has ${r} swords. He finds ${o} more in a chest. How many swords does he have now?`,m="Add them together.";break;case 1:r=e(2,Math.min(12,5+Math.floor(c/3))),o=e(2,Math.min(12,5+Math.floor(c/3))),i=r*o,l=`A dungeon has ${r} floors. Each floor has ${o} rooms. How many rooms are there in total?`,m="Multiply the numbers.";break;case 2:r=e(20,n*2),o=e(5,r-5),i=r-o,l=`A mage has ${r} mana points. She casts a spell costing ${o} mana. How much mana remains?`,m="Subtract to find the remainder.";break;default:r=10,o=5,i=15,l=`What is ${r} + ${o}?`,m="Basic addition."}let d=[i+e(1,5),i-e(1,5),i+e(6,10)].filter(h=>h!==i&&h>0),u=[i.toString(),...d.slice(0,3).map(String)],f=0;for(let h=u.length-1;h>0;h--){let b=Math.floor(t()*(h+1));[u[h],u[b]]=[u[b],u[h]]}return{question:l,options:u,correctIndex:u.indexOf(i.toString()),hint:m}}function Se(c){let a=y()?g():null,t=()=>a?a.nextFloat():Math.random(),e=t(),n;e<.5?n="riddle":e<.8?n="math":n="sequence";let s,r,o,i,l;switch(n){case"riddle":{let m=Me[Math.floor(t()*Me.length)];s="Ancient Riddle",r=m.question,o=[...m.options],i=m.correctIndex,l=m.hint;break}case"sequence":{let m=Math.min(3+Math.floor(c/5),5),d=[];for(let h=0;h<m;h++)d.push(Math.floor(t()*x.length));s="Elemental Sequence",r=`Repeat the sequence: ${d.map(h=>ct[h]).join(" \u2192 ")}`;let u=d.map(h=>x[h]).join(", "),f=[[...d].reverse().map(h=>x[h]).join(", "),d.map(h=>x[(h+1)%x.length]).join(", "),d.map(h=>x[(h+2)%x.length]).join(", ")];o=[u,...f],i=0;for(let h=o.length-1;h>0;h--){let b=Math.floor(t()*(h+1));[o[h],o[b]]=[o[b],o[h]]}i=o.indexOf(u),l="Follow the symbols in order.";break}case"math":{let m=lt(c);s="Numerical Challenge",r=m.question,o=m.options,i=m.correctIndex,l=m.hint;break}}return{id:crypto.randomUUID(),type:n,title:s,question:r,options:o,correctIndex:i,hint:l,solved:!1,attempts:0,maxAttempts:3,rewardMultiplier:1}}function Ce(c,a){if(c.solved)return{correct:!0,message:"This puzzle has already been solved.",complete:!0};if(c.attempts++,a===c.correctIndex)return c.solved=!0,c.rewardMultiplier=Math.max(.5,1-(c.attempts-1)*.25),{correct:!0,message:c.attempts===1?"Brilliant! You solved it on the first try!":`Correct! Solved in ${c.attempts} attempts.`,complete:!0};let t=c.maxAttempts-c.attempts;return t<=0?{correct:!1,message:`Wrong! The puzzle locks itself. The answer was: ${c.options[c.correctIndex]}`,complete:!0,remainingAttempts:0}:{correct:!1,message:`Incorrect. ${t} attempt${t>1?"s":""} remaining. Hint: ${c.hint}`,complete:!1,remainingAttempts:t}}var M={BASE_GOLD:50,BASE_XP:100,TREASURE_GOLD_MULTIPLIER:3,ELITE_MULTIPLIER:1.5,BOSS_XP_MULTIPLIER:3,BOSS_GOLD_MULTIPLIER:2,REST_HEALTH_RESTORE:100,COMBAT_XP_MULTIPLIER:1.2,PUZZLE_GOLD_MULTIPLIER:.5,PUZZLE_XP_MULTIPLIER:1.5,EVENT_GOLD_MULTIPLIER:.75,EVENT_XP_MULTIPLIER:.75},L=class c{constructor(a,t){this.id=crypto.randomUUID();this.enemiesLoaded=!1;this.interactables=[];this.type=a??"entrance",this.level=Math.max(1,t??1),this.state="locked",this.connections=[],this.interactables=[],this.reward=this.generateReward(),this.description=this.generateDescription()}static create(a,t){let e=new c(a,t);return e.populateInteractables(),e}connectTo(a){this.connections.includes(a.id)||this.connections.push(a.id),a.connections.includes(this.id)||a.connections.push(this.id)}canEnter(){return this.state==="locked"||this.state==="cleared"?!1:this.type==="entrance"||this.state==="available"}enter(){if(this.state==="locked")throw new Error("Room is locked");this.state="active",this.type==="event"&&!this.event&&(this.event=Ae(this.level)),this.type==="shop"&&!this.shopInventory&&(this.shopInventory=ve(this.level)),this.type==="puzzle"&&!this.puzzle&&(this.puzzle=Se(this.level))}async ensureEnemiesLoaded(){this.enemiesLoaded||!this.isHostileRoom()||(await this.populateEnemies(),this.enemiesLoaded=!0)}areEnemiesLoaded(){return this.enemiesLoaded||!this.isHostileRoom()}complete(){if(this.state!=="active")throw new Error("Room is not active");return this.state="cleared",this.reward}isHostileRoom(){return["combat","elite","boss"].includes(this.type)}generateReward(){let{BASE_GOLD:a,BASE_XP:t}=M,e=1,n=1;switch(this.type){case"treasure":e=M.TREASURE_GOLD_MULTIPLIER;break;case"elite":n=M.ELITE_MULTIPLIER,e=M.ELITE_MULTIPLIER;break;case"boss":n=M.BOSS_XP_MULTIPLIER,e=M.BOSS_GOLD_MULTIPLIER;break;case"rest":return{items:[],gold:0,experience:0,healthRestore:M.REST_HEALTH_RESTORE};case"shop":return{items:[],gold:a*this.level,experience:0};case"combat":n=M.COMBAT_XP_MULTIPLIER;break;case"puzzle":e=M.PUZZLE_GOLD_MULTIPLIER,n=M.PUZZLE_XP_MULTIPLIER;break;case"event":e=M.EVENT_GOLD_MULTIPLIER,n=M.EVENT_XP_MULTIPLIER;break;default:e=0,n=0;break}let s=Math.floor(a*e*this.level),r=Math.floor(t*n*this.level);return{items:this.generateItems(),gold:s,experience:r}}generateItems(){switch(this.type){case"treasure":return[...T(this.level,void 0,!0),...T(this.level)].map(e=>A(e));case"boss":return[...T(this.level+2,void 0,!0),...T(this.level+1,void 0,!0),...T(this.level)].map(e=>A(e));case"elite":return T(this.level+1,void 0,!0).map(e=>A(e));case"combat":let a=this.level<=2;return T(this.level,void 0,a).map(e=>A(e));case"puzzle":case"event":return(y()?g().chance(.5):Math.random()<.5)?T(this.level).map(e=>A(e)):[];default:return[]}}async populateEnemies(){if(!this.isHostileRoom())return;let a;if(this.type==="boss"||this.type==="elite")a=1;else{let t=Math.floor(this.level/3)+1,e=y()?g().nextInt(1,3):Math.floor(Math.random()*3)+1;a=Math.min(e,t)}this.enemies=await V.getRandomMonstersByCR(this.level,a)}populateInteractables(){let a=y()?g():null;switch(this.type){case"treasure":let t=a?a.nextInt(1,2):Math.floor(Math.random()*2)+1;for(let r=0;r<t;r++)this.interactables.push(S("chest",this.level));(a?a.chance(.3):Math.random()<.3)&&this.interactables.push(S("trap",this.level));break;case"combat":case"elite":(a?a.chance(.2):Math.random()<.2)&&this.interactables.push(S("chest",this.level)),(a?a.chance(.15):Math.random()<.15)&&this.interactables.push(S("trap",this.level));break;case"boss":this.interactables.push(S("chest",this.level+2));break;case"rest":this.interactables.push(S("altar",this.level));break;case"shop":this.interactables.push(S("npc",this.level));break;case"puzzle":let e=a?a.nextInt(1,3):Math.floor(Math.random()*3)+1;for(let r=0;r<e;r++)this.interactables.push(S("lever",this.level));(a?a.chance(.5):Math.random()<.5)&&this.interactables.push(S("trap",this.level));break;case"event":let n=["chest","altar","npc","trap"],s=a?a.choice(n):n[Math.floor(Math.random()*n.length)];this.interactables.push(S(s,this.level));break;case"entrance":break}}interactWith(a){let t=this.interactables.find(e=>e.id===a);return t?W(t):null}getAvailableInteractables(){return this.interactables.filter(a=>!a.used||a.type==="npc")}hasAvailableInteractables(){return this.getAvailableInteractables().length>0}getIcon(){return{entrance:"\u{1F6AA}",combat:"\u2694\uFE0F",elite:"\u{1F479}",treasure:"\u{1F48E}",rest:"\u{1F525}",shop:"\u{1F3EA}",event:"\u2753",boss:"\u{1F480}",puzzle:"\u{1F50D}"}[this.type]||"?"}generateDescription(){let a=y()?g():null,t=r=>{let o=a?a.nextInt(0,r.length-1):Math.floor(Math.random()*r.length);return r[o]},e=this.level<=5?t(["dimly lit","musty","damp","echoing","shadowy"]):this.level<=12?t(["ominous","foreboding","ancient","crumbling","haunted"]):t(["malevolent","corrupted","suffocating","nightmarish","abyssal"]),s={entrance:["Stone steps descend into the darkness below. The air grows cold as you enter the dungeon.","A weathered archway marks the entrance to the depths. Ancient runes flicker faintly on the walls.","The heavy iron gates creak open, revealing a passage into the unknown darkness.","Torchlight barely penetrates the gloom of this ancient entryway. Your adventure begins here."],combat:[`A ${e} chamber opens before you. Hostile eyes gleam in the darkness.`,`Bones crunch underfoot in this ${e} room. You are not alone.`,`The stench of danger fills this ${e} hall. Enemies lurk in the shadows.`,`Scratching sounds echo from the ${e} corners. Prepare for battle.`,`This ${e} room bears the marks of countless battles. Another awaits.`],elite:[`A powerful presence dominates this ${e} chamber. A formidable foe awaits.`,`The air crackles with dark energy in this ${e} hall. A champion guards this room.`,`Trophies of fallen adventurers line the walls of this ${e} lair. Beware.`,`An unnatural chill pervades this ${e} sanctum. Something powerful stirs within.`],boss:["The final chamber looms before you. Darkness incarnate awaits your challenge.","Ancient power thrums through the air. The master of this dungeon awaits.","Massive pillars support a vaulted ceiling lost in shadow. Your ultimate test begins.","The heart of the dungeon pulses with malevolent energy. Face your destiny."],treasure:[`Glittering gold catches the torchlight in this ${e} vault.`,`Chests and coffers fill this ${e} chamber. Riches await the bold.`,`The gleam of precious metals illuminates this ${e} room.`,`Ancient treasures lie scattered across this ${e} treasury.`],rest:["A peaceful alcove offers respite from the dangers of the dungeon. A warm fire crackles.","Soft moss covers the floor of this sanctuary. The air feels lighter here.","An ancient shrine radiates calming energy. Rest and recover your strength.","A hidden campsite provides shelter. The dungeon's dangers seem distant here."],shop:["A mysterious merchant has set up shop in this unlikely location. Wares glitter on display.","Lanterns illuminate a small bazaar. A hooded figure beckons you to browse.","A traveling trader offers goods in this protected alcove. Gold for gear, adventurer?","Shelves of potions and equipment line the walls. A shopkeeper awaits your patronage."],event:[`Something unusual catches your attention in this ${e} chamber.`,`The air shimmers with possibility in this ${e} room. Fate awaits.`,`An otherworldly presence permeates this ${e} space. Choose wisely.`,`Strange energies swirl in this ${e} alcove. Destiny calls.`],puzzle:[`Intricate mechanisms line the walls of this ${e} chamber. A test of wit awaits.`,`Ancient symbols cover every surface of this ${e} room. Solve the riddle.`,`Mysterious contraptions fill this ${e} hall. Logic is your weapon here.`,"The room hums with arcane energy. A puzzle blocks your path forward."]}[this.type]||[`A ${e} chamber stretches before you.`];return t(s)}toJSON(){return{id:this.id,type:this.type,level:this.level,state:this.state,connections:this.connections,reward:this.reward,enemies:this.enemies,interactables:this.interactables,description:this.description}}};v();var N=[0,100,300,600,1e3,1500,2100,2800,3600,4500,5500,6600,7800,9100,10500,12e3,13600,15300,17100,19e3],P=20;function ce(c){return c>=P?N[P-1]:N[c]}function we(c,a){if(c>=P)return 100;let t=c>1?N[c-1]:0,e=N[c],n=a-t,s=e-t;return Math.min(100,n/s*100)}var Ie=50,xe=50;var mt={fighter:{maxHealth:120,health:120,attack:14,defense:10,mana:30,maxMana:30,speed:25,critChance:15,critMultiplier:1.75},warlock:{maxHealth:80,health:80,attack:6,defense:6,mana:100,maxMana:100,speed:20,critChance:10,critMultiplier:1.75}},dt={fighter:{maxHealth:15,attack:2,defense:2,mana:5,maxMana:5,speed:1,critChance:.5},warlock:{maxHealth:8,attack:1,defense:1,mana:15,maxMana:15,speed:1,critChance:1}},$=class{constructor(a,t){this.id=crypto.randomUUID();this.level=1;this.experience=0;this.gold=0;this.equipment={weapon:null,armor:null,accessory:null};this.inventory=[];this.abilities=[];this.activeBuffs=[];this.relics=[];this.name=a,this.playerClass=t,this.stats={...mt[t]},this.initializeAbilities()}getEquipmentBonus(a){let t=0,e=[this.equipment.weapon,this.equipment.armor,this.equipment.accessory];for(let n of e)n?.bonuses?.[a]&&(t+=n.bonuses[a]);return t}getBuffBonus(a){let t=0;for(let e of this.activeBuffs)e.bonuses[a]&&(t+=e.bonuses[a]);return t}getRelicBonus(a){let t=0;for(let e of this.relics)e.type==="stat_boost"&&e.statBonus?.[a]&&(t+=e.statBonus[a]);return t}getAttackPower(){let a=this.stats.attack;return this.equipment.weapon?.damage&&(a+=Ee(this.equipment.weapon.damage.dice)),a+=this.getEquipmentBonus("attack"),a+=this.getBuffBonus("attack"),a+=this.getRelicBonus("attack"),Math.floor(a)}getDefense(){let a=this.stats.defense;return this.equipment.armor?.armorClass&&(a+=this.equipment.armor.armorClass),a+=this.getEquipmentBonus("defense"),a+=this.getBuffBonus("defense"),a+=this.getRelicBonus("defense"),a}getMaxHealth(){return this.stats.maxHealth+this.getEquipmentBonus("maxHealth")+this.getBuffBonus("maxHealth")+this.getRelicBonus("maxHealth")}getMaxMana(){return this.stats.maxMana+this.getEquipmentBonus("maxMana")+this.getBuffBonus("maxMana")+this.getRelicBonus("maxMana")}getSpeed(){return this.stats.speed+this.getEquipmentBonus("speed")+this.getBuffBonus("speed")+this.getRelicBonus("speed")}getCritChance(){return this.stats.critChance+this.getEquipmentBonus("critChance")+this.getBuffBonus("critChance")+this.getRelicBonus("critChance")}getCritMultiplier(){return this.stats.critMultiplier+(this.getEquipmentBonus("critMultiplier")??0)+(this.getBuffBonus("critMultiplier")??0)+(this.getRelicBonus("critMultiplier")??0)}getAllAbilities(){let a=[...this.abilities],t=[this.equipment.weapon,this.equipment.armor,this.equipment.accessory];for(let e of t)e?.grantedAbility&&a.findIndex(s=>s.id===e.grantedAbility.id)===-1&&a.push({...e.grantedAbility,currentCooldown:0,source:e.name});for(let e of this.relics)e.type==="ability"&&e.grantedAbility&&a.findIndex(s=>s.id===e.grantedAbility.id)===-1&&a.push({...e.grantedAbility,currentCooldown:0,source:e.name});return a}addRelic(a){this.relics.push(a),a.type==="stat_boost"&&a.statBonus&&(a.statBonus.maxHealth&&(this.stats.health=Math.min(this.stats.health+a.statBonus.maxHealth,this.getMaxHealth())),a.statBonus.maxMana&&(this.stats.mana=Math.min(this.stats.mana+a.statBonus.maxMana,this.getMaxMana())))}getPassiveEffects(){return this.relics.filter(a=>a.type==="passive"&&a.passiveEffect).map(a=>a.passiveEffect)}getCombatModifiers(){return this.relics.filter(a=>a.type==="combat_modifier"&&a.combatModifier).map(a=>a.combatModifier)}hasPassiveEffect(a){return this.getPassiveEffects().find(t=>t.type===a)}getPassiveEffectValue(a){return this.getPassiveEffects().filter(t=>t.type===a).reduce((t,e)=>t+e.value,0)}processPassiveEffects(){let a=0,t=0,e=this.getPassiveEffectValue("health_regen");e>0&&this.stats.health<this.getMaxHealth()&&(a=Math.min(e,this.getMaxHealth()-this.stats.health),this.stats.health+=a);let n=this.getPassiveEffectValue("mana_regen");return n>0&&this.stats.mana<this.getMaxMana()&&(t=Math.min(n,this.getMaxMana()-this.stats.mana),this.stats.mana+=t),{healthRegen:a,manaRegen:t}}getOwnedRelicBaseIds(){return this.relics.map(a=>a.id.split("-")[0]+"_"+a.id.split("_").slice(1).join("_").split("-")[0])}processOnHitEffects(){let a=[],t=[this.equipment.weapon,this.equipment.accessory];for(let e of t)e?.onHit&&(y()?g().percentChance(e.onHit.chance):Math.random()*100<e.onHit.chance)&&a.push({type:e.onHit.type,value:e.onHit.value,duration:e.onHit.duration});return a}isAlive(){return this.stats.health>0}takeDamage(a){a<=0&&(a=0);let t=this.getDefense(),e=Math.floor(t/2),n=Math.max(1,a-e);return this.stats.health=Math.max(0,this.stats.health-n),n}heal(a){if(a<=0)return 0;let t=this.stats.health,e=this.getMaxHealth();return this.stats.health=Math.min(e,this.stats.health+a),this.stats.health-t}restoreMana(a){if(a<=0)return 0;let t=this.stats.mana,e=this.getMaxMana();return this.stats.mana=Math.min(e,this.stats.mana+a),this.stats.mana-t}useMana(a){return this.stats.mana<a?!1:(this.stats.mana-=a,!0)}applyBuff(a,t,e){let n=this.activeBuffs.find(s=>s.name===a);if(n){n.remainingTurns=Math.max(n.remainingTurns,e);return}this.activeBuffs.push({name:a,bonuses:t,remainingTurns:e})}tickBuffs(){for(let a=this.activeBuffs.length-1;a>=0;a--)this.activeBuffs[a].remainingTurns--,this.activeBuffs[a].remainingTurns<=0&&this.activeBuffs.splice(a,1)}addExperience(a){this.experience+=a;let t=0;for(;this.level<P&&this.experience>=N[this.level];)this.levelUp(),t++;return{levelsGained:t,newLevel:this.level}}levelUp(){this.level++;let a=dt[this.playerClass];a.maxHealth&&(this.stats.maxHealth+=a.maxHealth,this.stats.health+=a.maxHealth),a.attack&&(this.stats.attack+=a.attack),a.defense&&(this.stats.defense+=a.defense),a.mana&&(this.stats.maxMana+=a.mana,this.stats.mana+=a.mana),a.maxMana&&(this.stats.maxMana+=a.maxMana),a.speed&&(this.stats.speed+=a.speed),a.critChance&&(this.stats.critChance+=a.critChance),this.stats.health=this.stats.maxHealth,this.stats.mana=this.stats.maxMana}getExperienceToNextLevel(){return this.level>=P?0:N[this.level]-this.experience}addGold(a){a<=0||(this.gold+=a)}spendGold(a){return this.gold<a?!1:(this.gold-=a,!0)}equipItem(a){if(a.slot==="none"||a.slot==="consumable")return null;let t=null;switch(a.slot){case"weapon":t=this.equipment.weapon,this.equipment.weapon=a;break;case"armor":t=this.equipment.armor,this.equipment.armor=a;break;case"accessory":t=this.equipment.accessory,this.equipment.accessory=a;break}let e=this.inventory.findIndex(n=>n.id===a.id);return e!==-1&&this.inventory.splice(e,1),t&&this.inventory.push(t),t}unequipSlot(a){let t=null;switch(a){case"weapon":t=this.equipment.weapon,this.equipment.weapon=null;break;case"armor":t=this.equipment.armor,this.equipment.armor=null;break;case"accessory":t=this.equipment.accessory,this.equipment.accessory=null;break}return t&&this.inventory.push(t),t}useConsumable(a){if(a.type!=="consumable"||!a.consumeEffect)return!1;let t=this.inventory.findIndex(n=>n.id===a.id);if(t===-1)return!1;let e=a.consumeEffect;if(e.healing){let n=D(e.healing.dice)+e.healing.bonus;this.heal(n)}return e.manaRestore&&this.restoreMana(e.manaRestore),e.buff&&e.buffDuration&&this.applyBuff(a.name,e.buff,e.buffDuration),this.inventory.splice(t,1),!0}addToInventory(a){this.inventory.push(a)}removeFromInventory(a){let t=this.inventory.findIndex(e=>e.id===a);return t===-1?null:this.inventory.splice(t,1)[0]}getInventoryByType(a){return this.inventory.filter(t=>t.type===a)}basicAttack(){let a=this.getAttackPower(),t=this.getCritChance(),e=this.getCritMultiplier(),n=y()?g().percentChance(t):Math.random()*100<t,s=n?Math.floor(a*e):a,r=this.processOnHitEffects();return{damage:s,isCrit:n,onHitEffects:r}}useAbility(a){let t=this.abilities.find(e=>e.id===a);return t||(t=this.getAllAbilities().find(n=>n.id===a)),!t||t.currentCooldown>0||!this.useMana(t.manaCost)?null:(t.currentCooldown=t.cooldown,t)}tickCooldowns(){for(let t of this.abilities)t.currentCooldown>0&&t.currentCooldown--;let a=[this.equipment.weapon,this.equipment.armor,this.equipment.accessory];for(let t of a)t?.grantedAbility&&t.grantedAbility.currentCooldown>0&&t.grantedAbility.currentCooldown--}endTurn(){this.tickCooldowns(),this.tickBuffs()}rest(){this.stats.health=this.getMaxHealth(),this.stats.mana=this.getMaxMana();for(let a of this.abilities)a.currentCooldown=0;this.activeBuffs=[]}toJSON(){return{id:this.id,name:this.name,playerClass:this.playerClass,level:this.level,experience:this.experience,gold:this.gold,stats:{...this.stats},equipment:{weapon:this.equipment.weapon?.id??null,armor:this.equipment.armor?.id??null,accessory:this.equipment.accessory?.id??null},inventory:this.inventory.map(a=>a.id),abilities:this.abilities.map(a=>({...a})),activeBuffs:this.activeBuffs.map(a=>({...a}))}}};var k=class c extends ${constructor(a){super(a,"fighter")}initializeAbilities(){this.abilities=[{id:"power_strike",name:"Power Strike",description:"A devastating blow that deals 150% weapon damage.",manaCost:10,cooldown:1,currentCooldown:0,damage:1.5,source:"class"},{id:"shield_bash",name:"Shield Bash",description:"Bash the enemy, dealing moderate damage and stunning them for 1 turn.",manaCost:15,cooldown:3,currentCooldown:0,damage:.75,effect:"stun",source:"class"},{id:"battle_cry",name:"Battle Cry",description:"Let out a fierce cry, increasing attack by 25% for 3 turns.",manaCost:20,cooldown:5,currentCooldown:0,effect:"attack_buff",source:"class"},{id:"second_wind",name:"Second Wind",description:"Catch your breath and recover 30% of max health.",manaCost:25,cooldown:6,currentCooldown:0,healing:.3,source:"class"},{id:"whirlwind",name:"Whirlwind",description:"Spin and strike all enemies for 75% weapon damage.",manaCost:30,cooldown:4,currentCooldown:0,damage:.75,effect:"aoe",source:"class"}]}powerStrike(){let a=this.useAbility("power_strike");if(!a)return null;let t=this.basicAttack();return{damage:Math.floor(t.damage*(a.damage??1.5)),isCrit:t.isCrit}}shieldBash(){let a=this.useAbility("shield_bash");if(!a)return null;let t=this.basicAttack();return{damage:Math.floor(t.damage*(a.damage??.75)),stunned:!0}}battleCry(){if(!this.useAbility("battle_cry"))return null;let t=Math.floor(this.stats.attack*.25);return this.applyBuff("Battle Cry",{attack:t},3),{attackBonus:t,duration:3}}secondWind(){let a=this.useAbility("second_wind");if(!a)return null;let t=Math.floor(this.getMaxHealth()*(a.healing??.3));return this.heal(t)}whirlwind(){let a=this.useAbility("whirlwind");if(!a)return null;let t=this.basicAttack();return{damage:Math.floor(t.damage*(a.damage??.75)),isAoe:!0}}checkLastStand(){return this.stats.health/this.getMaxHealth()<=.25?{defenseBonus:Math.floor(this.stats.defense*.5),active:!0}:{defenseBonus:0,active:!1}}getDefense(){let a=super.getDefense(),t=this.checkLastStand();return a+t.defenseBonus}static fromJSON(a,t){let e=new c(a.name);if(e.level=a.level,e.experience=a.experience,e.gold=a.gold,e.stats={...a.stats},a.equipment.weapon){let n=t.get(a.equipment.weapon);n&&(e.equipment.weapon=n)}if(a.equipment.armor){let n=t.get(a.equipment.armor);n&&(e.equipment.armor=n)}if(a.equipment.accessory){let n=t.get(a.equipment.accessory);n&&(e.equipment.accessory=n)}return e.inventory=a.inventory.map(n=>t.get(n)).filter(n=>n!==void 0),e.abilities=a.abilities.map(n=>({...n})),e.activeBuffs=a.activeBuffs.map(n=>({...n})),e}};v();var Z=class{constructor(a){this.rooms=[];this.layers=[];this.rng=de(a)}generate(a=20,t=3,e=.3){this.rooms=[],this.layers=[],this.createEntrance();for(let n=2;n<a;n++)this.generateLevel(n,t,e);return this.createBoss(a),this.placeSpecialRooms(),this.rooms}createEntrance(){let a=L.create("entrance",1);a.state="available",this.rooms.push(a),this.layers.push({level:1,rooms:[a]})}generateLevel(a,t,e){let n=this.layers[this.layers.length-1],s=[],r=this.calculateRoomCount(a,t,n.rooms.length);for(let o=0;o<r;o++){let i=this.selectRoomType(a),l=L.create(i,a);s.push(l),this.rooms.push(l)}this.connectLayers(n.rooms,s,e),this.layers.push({level:a,rooms:s})}calculateRoomCount(a,t,e,n=20){let s=n-a;return a<=5?Math.min(t,e+this.rng.nextInt(0,1)):a<=10?Math.min(t,e+this.rng.nextInt(0,2)):s<=5?s<=2?Math.max(1,e-this.rng.nextInt(1,2)):Math.max(2,e-this.rng.nextInt(0,1)):Math.max(2,e+this.rng.nextInt(-1,1))}selectRoomType(a){let t=a/20,e=this.rng.nextFloat();return t<.3?e<.7?"combat":e<.85?"treasure":e<.93?"rest":"event":t<.7?e<.6?"combat":e<.72?"elite":e<.82?"treasure":e<.9?"shop":e<.96?"rest":"puzzle":e<.5?"combat":e<.7?"elite":e<.82?"treasure":e<.92?"puzzle":"event"}connectLayers(a,t,e){let n=new Set,s=new Set;for(let r of a){let o=this.rng.choice(t);r.connectTo(o),n.add(o.id),s.add(r.id)}for(let r of a){let i=this.calculateConnections(a.length,t.length,e)-1;for(let l=0;l<i;l++){let m=t.filter(d=>!r.connections.includes(d.id));if(m.length>0){let d=this.rng.choice(m);r.connectTo(d),n.add(d.id)}}}for(let r of t)n.has(r.id)||this.rng.choice(a).connectTo(r)}calculateConnections(a,t,e){let n=1;return t>a?n=this.rng.nextFloat()<.5?1:2:t<a?n=1:n=this.rng.nextFloat()<e?2:1,n}createBoss(a){let t=L.create("boss",a),e=this.layers[this.layers.length-1];for(let n of e.rooms)n.connectTo(t);this.rooms.push(t),this.layers.push({level:a,rooms:[t]})}placeSpecialRooms(){for(let r=5;r<20;r+=5){let o=this.layers[r-1];if(o&&o.rooms.length>0){let i=this.rng.choice(o.rooms);i.type==="combat"&&(i.type="rest")}}let t=this.rng.nextInt(10,15),e=this.layers[t-1];if(e){let r=this.rng.choice(e.rooms);r.type="shop"}let n=this.rng.nextInt(3,8),s=this.layers[n-1];if(s){let r=this.rng.choice(s.rooms);r.type!=="rest"&&(r.type="treasure")}}getLayers(){return this.layers}validateConnectivity(){let a=[],t=new Map;for(let i of this.rooms)t.set(i.id,i);for(let i=1;i<this.layers.length-1;i++){let l=this.layers[i],m=this.layers[i-1],d=this.layers[i+1];for(let u of l.rooms)m.rooms.some(b=>b.connections.includes(u.id))||a.push(`Level ${l.level} room ${u.id} has no incoming connection from level ${m.level}`),u.connections.some(b=>d.rooms.some(R=>R.id===b))||a.push(`Level ${l.level} room ${u.id} has no outgoing connection to level ${d.level}`)}let e=this.layers[0].rooms[0],n=this.layers[1];e.connections.some(i=>n.rooms.some(l=>l.id===i))||a.push("Entrance has no connection to level 2");let r=this.layers[this.layers.length-2],o=this.layers[this.layers.length-1].rooms[0];for(let i of r.rooms)i.connections.includes(o.id)||a.push(`Level ${r.level} room ${i.id} does not connect to boss`);return a}};v();var _=class c extends ${constructor(t){super(t,"warlock");this.soulShards=0;this.maxSoulShards=3}initializeAbilities(){this.abilities=[{id:"eldritch_blast",name:"Eldritch Blast",description:"Fire a beam of crackling energy, dealing magic damage.",manaCost:6,cooldown:1,currentCooldown:0,damage:8,source:"class"},{id:"drain_life",name:"Drain Life",description:"Siphon life from an enemy, dealing damage and healing yourself for 40% of damage dealt.",manaCost:15,cooldown:3,currentCooldown:0,damage:6,effect:"lifesteal",source:"class"},{id:"hex",name:"Hex",description:"Curse an enemy, increasing damage they take by 20% for 3 turns.",manaCost:12,cooldown:4,currentCooldown:0,effect:"debuff",source:"class"},{id:"shadow_bolt",name:"Shadow Bolt",description:"Hurl a bolt of shadow energy. Consumes soul shards for bonus damage.",manaCost:18,cooldown:2,currentCooldown:0,damage:12,source:"class"},{id:"dark_pact",name:"Dark Pact",description:"Sacrifice 15% of current health to restore 30% of max mana.",manaCost:0,cooldown:5,currentCooldown:0,effect:"mana_restore",source:"class"},{id:"soul_harvest",name:"Soul Harvest",description:"Passive: Killing an enemy grants a soul shard (max 3). Active: Consume all shards to deal damage.",manaCost:25,cooldown:6,currentCooldown:0,damage:10,effect:"consume_shards",source:"class"}]}gainSoulShard(){return this.soulShards<this.maxSoulShards?(this.soulShards++,!0):!1}eldritchBlast(){let t=this.useAbility("eldritch_blast");if(!t)return null;let e=t.damage??8,n=this.getCritChance(),s=this.getCritMultiplier(),r=y()?g().percentChance(n):Math.random()*100<n;return{damage:(r?Math.floor(e*s):e)+Math.floor(this.level*1),isCrit:r}}drainLife(){let t=this.useAbility("drain_life");if(!t)return null;let e=(t.damage??6)+Math.floor(this.level*.8),n=this.getCritChance(),s=this.getCritMultiplier(),o=(y()?g().percentChance(n):Math.random()*100<n)?Math.floor(e*s):e,i=this.heal(Math.floor(o*.4));return{damage:o,healed:i}}hex(){return this.useAbility("hex")?{damageIncrease:.2,duration:3}:null}shadowBolt(){let t=this.useAbility("shadow_bolt");if(!t)return null;let e=(t.damage??12)+Math.floor(this.level*1.2),n=this.soulShards*4,s=this.soulShards;this.soulShards=0;let r=this.getCritChance(),o=this.getCritMultiplier(),i=y()?g().percentChance(r):Math.random()*100<r,l=e+n;return{damage:i?Math.floor(l*o):l,isCrit:i,shardsConsumed:s}}darkPact(){if(!this.useAbility("dark_pact"))return null;let e=Math.floor(this.stats.health*.15),n=Math.floor(this.getMaxMana()*.3);if(this.stats.health<=e)return null;this.stats.health-=e;let s=this.restoreMana(n);return{healthLost:e,manaRestored:s}}soulHarvest(){if(this.soulShards===0)return null;let t=this.useAbility("soul_harvest");if(!t)return null;let n=((t.damage??10)+Math.floor(this.level*1.5))*this.soulShards,s=this.soulShards;return this.soulShards=0,{damage:n,shardsConsumed:s}}basicAttack(){let t=super.basicAttack();return this.restoreMana(3),t}toJSON(){return{...super.toJSON(),soulShards:this.soulShards}}static fromJSON(t,e){let n=new c(t.name);if(n.level=t.level,n.experience=t.experience,n.gold=t.gold,n.stats={...t.stats},n.soulShards=t.soulShards??0,t.equipment.weapon){let s=e.get(t.equipment.weapon);s&&(n.equipment.weapon=s)}if(t.equipment.armor){let s=e.get(t.equipment.armor);s&&(n.equipment.armor=s)}if(t.equipment.accessory){let s=e.get(t.equipment.accessory);s&&(n.equipment.accessory=s)}return n.inventory=t.inventory.map(s=>e.get(s)).filter(s=>s!==void 0),n.abilities=t.abilities.map(s=>({...s})),n.activeBuffs=t.activeBuffs.map(s=>({...s})),n}};v();var H=class{equipItem(a,t){let e=a.inventory.find(s=>s.id===t);return e?a.equipItem(e)?{type:"item_equipped",success:!0,message:`Equipped ${e.name}`,result:{item:e}}:{type:"equip_failed",success:!1,message:`Cannot equip ${e.name}`}:{type:"equip_failed",success:!1,message:"Item not found"}}unequipItem(a,t){if(!t)return{type:"unequip_failed",success:!1,message:"No slot specified"};let n={weapon:"weapon",armor:"armor",accessory:"accessory"}[t];if(!n)return{type:"unequip_failed",success:!1,message:"Invalid slot"};let s=a.equipment[t];if(!s)return{type:"unequip_failed",success:!1,message:"No item in that slot"};let r=a.unequipSlot(n);return r?{type:"item_unequipped",success:!0,message:`Unequipped ${s.name}`,result:{item:r}}:{type:"unequip_failed",success:!1,message:`Cannot unequip ${s.name}`}}useItem(a,t){let e=a.inventory.find(s=>s.id===t);if(!e)return{type:"use_failed",success:!1,message:"Item not found"};let n=a.useConsumable(e);return{type:"item_used",success:n,message:n?`Used ${e.name}`:"Failed to use item",result:{item:e}}}};var U=class{buyItem(a,t,e,n){if(!t?.shopInventory)return{type:"buy_failed",success:!1,message:"No shop here"};let s=t.shopInventory.findIndex(o=>o.item.id===e);if(s===-1)return{type:"buy_failed",success:!1,message:"Item not in shop"};let r=t.shopInventory[s];return a.gold<r.buyPrice?{type:"buy_failed",success:!1,message:`Not enough gold (need ${r.buyPrice}, have ${a.gold})`}:(a.gold-=r.buyPrice,a.addToInventory(r.item),t.shopInventory.splice(s,1),n.itemsFound++,{type:"item_bought",success:!0,message:`Bought ${r.item.name} for ${r.buyPrice} gold`,result:{item:r.item,gold:-r.buyPrice}})}sellItem(a,t,e){let n=a.inventory.find(o=>o.id===t);if(!n)return{type:"sell_failed",success:!1,message:"Item not found"};let s=G(n),r=a.inventory.findIndex(o=>o.id===t);return a.inventory.splice(r,1),a.addGold(s),e.goldCollected+=s,{type:"item_sold",success:!0,message:`Sold ${n.name} for ${s} gold`,result:{item:n,gold:s}}}getSellPrice(a,t){let e=t.inventory.find(n=>n.id===a);return e?G(e):0}};var F=class{interact(a,t,e,n){if(!t)return{result:{type:"interact_failed",success:!1,message:"No room"},playerDied:!1};if(e===void 0||!t.interactables[e])return{result:{type:"interact_failed",success:!1,message:"Nothing to interact with"},playerDied:!1};let s=t.interactables[e],r=W(s),o=!1;return r.gold&&r.gold>0&&(a.addGold(r.gold),n.goldCollected+=r.gold),r.items&&r.items.length>0&&r.items.forEach(i=>{a.addToInventory(i),n.itemsFound++}),r.damage&&r.damage>0&&(a.takeDamage(r.damage),a.isAlive()||(o=!0)),r.healing&&r.healing>0&&a.heal(r.healing),r.statBonus&&a.applyBuff("Blessing",r.statBonus,r.duration||10),{result:{type:"interacted",success:!0,message:r.message,result:r},playerDied:o}}};var z=class{attemptAnswer(a,t,e,n){if(!t?.puzzle)return{result:{type:"puzzle_failed",success:!1,message:"No puzzle here"},roomComplete:!1};if(e===void 0)return{result:{type:"puzzle_failed",success:!1,message:"No answer provided"},roomComplete:!1};let s=Ce(t.puzzle,e);if(s.complete&&s.correct){let r=50*t.level,o=Math.floor(r*t.puzzle.rewardMultiplier),i=Math.floor(30*t.level*t.puzzle.rewardMultiplier);return a.addExperience(o),a.addGold(i),n.goldCollected+=i,{result:{type:"puzzle_solved",success:!0,message:`${s.message} You earned ${o} XP and ${i} gold!`,result:{gold:i}},newPhase:"exploration",roomComplete:!0}}else return s.complete&&!s.correct?{result:{type:"puzzle_failed",success:!1,message:s.message},newPhase:"exploration",roomComplete:!0}:{result:{type:"puzzle_wrong",success:!1,message:s.message},roomComplete:!1}}skipPuzzle(a){return a?.puzzle?{result:{type:"puzzle_skipped",success:!0,message:"You decided to skip the puzzle, forfeiting any rewards."},newPhase:"exploration",roomComplete:!0}:{result:{type:"puzzle_skipped",success:!0,message:"No puzzle to skip"},roomComplete:!1}}};var q=class{executeEvent(a,t,e){if(!t)return{result:{type:"event",success:!1,message:"Cannot execute event"},playerDied:!1,newPhase:"exploration"};if(!t.event)return{result:{type:"event",success:!1,message:"No event in this room"},playerDied:!1,newPhase:"exploration"};let n=t.event,s=n.outcome,r=Te(s),o=!1;switch(s.type){case"buff":s.statBonus&&s.duration&&a.applyBuff(n.title,s.statBonus,s.duration);break;case"debuff":if(s.statBonus&&s.duration){let i={...s.statBonus};for(let l in i)i[l]!==void 0&&(i[l]=-i[l]);a.applyBuff(n.title,i,s.duration)}break;case"weapon":case"armor":case"potion":s.item&&(a.addToInventory(s.item),e.itemsFound++);break;case"gold":s.gold&&(a.addGold(s.gold),e.goldCollected+=s.gold);break;case"heal":if(s.healthChange){let i=Math.floor(a.getMaxHealth()*s.healthChange);a.heal(i),r=`You feel revitalized! Healed for ${i} HP.`}break;case"damage":if(s.healthChange){let i=Math.floor(a.getMaxHealth()*Math.abs(s.healthChange));a.takeDamage(i),r=`Dark energy surges through you! Took ${i} damage.`,a.isAlive()||(o=!0,r+=" You have been slain!")}break}return t.complete(),{result:{type:"event",success:!0,message:r},playerDied:o,newPhase:"exploration"}}};var K=class{constructor(){this.previousPhase=null;this.inventoryManager=new H;this.shopManager=new U;this.interactionManager=new F;this.puzzleManager=new z;this.eventManager=new q;this.lastRoomRewards=null;this.currentGameState={player:null,dungeon:{rooms:new Map,layers:[],currentRoomId:null},phase:"exploration",combat:null,turn:0,stats:{roomsCleared:0,enemiesDefeated:0,goldCollected:0,itemsFound:0},seed:""}}startNewGame(a,t,e){let n;switch(a){case"fighter":n=new k(t);break;case"warlock":n=new _(t);break}let s=new Z(e),r=s.generate(20,3,.3),o=s.getLayers(),i=s.validateConnectivity();i.length>0&&console.warn("Dungeon connectivity issues found:",i);let l=new Map;for(let d of r)l.set(d.id,d);let m=r[0];m.state="available",m.enter();for(let d of m.connections){let u=l.get(d);u&&u.state==="locked"&&(u.state="available")}return this.currentGameState={player:n,dungeon:{rooms:l,layers:o,currentRoomId:m.id},phase:"exploration",combat:null,turn:0,stats:{roomsCleared:0,enemiesDefeated:0,goldCollected:0,itemsFound:0},seed:e},this.currentGameState}getState(){return this.currentGameState}getCurrentRoom(){let{dungeon:a}=this.currentGameState;return a.currentRoomId?a.rooms.get(a.currentRoomId):null}getCurrentRoomId(){return this.currentGameState.dungeon.currentRoomId}async moveToRoom(a){let{dungeon:t,stats:e}=this.currentGameState,n=t.rooms.get(a);if(!n)throw new Error(`Room ${a} not found`);let s=t.rooms.get(t.currentRoomId);if(s&&!s.connections.includes(a))throw new Error(`Room ${a} is not connected to current room`);if(!n.canEnter())throw new Error(`Room ${a} cannot be entered`);s&&s.state==="active"&&(s.state="cleared",e.roomsCleared++);let r=n.level;for(let[o,i]of t.rooms)o!==a&&(i.state==="cleared"||i.state==="locked"||(i.level===r&&i.state==="available"&&(i.state="locked"),i.level>r&&i.state==="available"&&(n.connections.includes(o)||(i.state="locked"))));t.currentRoomId=a,n.enter();for(let o of n.connections){let i=t.rooms.get(o);i&&i.state==="locked"&&i.level>r&&(i.state="available")}return n.isHostileRoom()&&await n.ensureEnemiesLoaded(),this.currentGameState.phase=this.determinePhaseForRoom(n),this.currentGameState}determinePhaseForRoom(a){switch(a.type){case"combat":case"elite":case"boss":return a.enemies&&a.enemies.length>0?"combat":"exploration";case"shop":return"shop";case"rest":return"rest";case"event":return"event";case"puzzle":return a.puzzle&&!a.puzzle.solved&&a.puzzle.attempts<a.puzzle.maxAttempts?"puzzle":"exploration";case"treasure":return"treasure";case"entrance":default:return"exploration"}}completeRoom(){let a=this.getCurrentRoom();if(!a)throw new Error("No current room");if(a.state!=="active")throw new Error("Room is not active");if(this.currentGameState.phase==="combat"&&this.currentGameState.dungeon.rooms.get(this.currentGameState.dungeon.currentRoomId)?.enemies?.some(n=>n.health>0))throw new Error("Cannot complete room in combat");let t=a.complete(),{player:e}=this.currentGameState;return e&&(e.addGold(t.gold),e.addExperience(t.experience),e.inventory.push(...t.items),t.healthRestore&&e.heal(t.healthRestore)),this.currentGameState.stats.goldCollected+=t.gold,this.currentGameState.stats.itemsFound+=t.items.length,this.currentGameState.stats.enemiesDefeated+=a.enemies?.length??0,this.lastRoomRewards={gold:t.gold,experience:t.experience,items:[...t.items],healthRestore:t.healthRestore},a.type==="boss"?this.currentGameState.phase="victory":this.currentGameState.phase="exploration",this.currentGameState.combat=null,this.currentGameState}getAndClearLastRewards(){let a=this.lastRoomRewards;return this.lastRoomRewards=null,a}getAvailableActions(){let a=[],{player:t}=this.currentGameState,e=this.getCurrentRoom();if(!t)throw new Error("No player");switch(this.currentGameState.phase){case"exploration":if(!e)throw new Error("No current room");for(let n of e.connections){let s=this.currentGameState.dungeon.rooms.get(n);s&&s.canEnter()&&a.push({type:"move",roomId:n,roomType:s.type})}e.interactables.forEach((n,s)=>{(!n.used||n.type==="npc")&&a.push({type:"interact",interactableIndex:s,interactableName:n.name})}),a.push({type:"open_inventory"}),a.push({type:"view_character"});break;case"combat":a.push({type:"basic_attack"});for(let n of t.getAllAbilities())n.currentCooldown===0&&t.stats.mana>=n.manaCost&&a.push({type:"ability",abilityId:n.id,name:n.name});for(let n of t.getInventoryByType("consumable"))a.push({type:"use_item",itemId:n.id,name:n.name});e&&e.type!=="boss"&&a.push({type:"flee"});break;case"shop":if(e?.shopInventory)for(let n of e.shopInventory)a.push({type:"buy_item",itemId:n.item.id,itemName:n.item.name,price:n.buyPrice});if(t)for(let n of t.inventory){let s=G(n);a.push({type:"sell_item",itemId:n.id,itemName:n.name,price:s})}a.push({type:"leave_shop"});break;case"rest":a.push({type:"rest"}),a.push({type:"leave"});break;case"event":a.push({type:"accept_event",name:"Accept Your Fate"});break;case"game_over":a.push({type:"restart"}),a.push({type:"quit"});break;case"victory":a.push({type:"view_stats"}),a.push({type:"restart"});break;case"inventory":if(a.push({type:"close_inventory"}),t){for(let n of t.inventory)(n.type==="weapon"||n.type==="armor"||n.type==="accessory")&&a.push({type:"equip_item",itemId:n.id,itemName:n.name}),n.type==="consumable"&&a.push({type:"use_item",itemId:n.id,itemName:n.name});t.equipment.weapon&&a.push({type:"unequip_item",itemId:t.equipment.weapon.id,itemName:t.equipment.weapon.name,slot:"weapon"}),t.equipment.armor&&a.push({type:"unequip_item",itemId:t.equipment.armor.id,itemName:t.equipment.armor.name,slot:"armor"}),t.equipment.accessory&&a.push({type:"unequip_item",itemId:t.equipment.accessory.id,itemName:t.equipment.accessory.name,slot:"accessory"})}break;case"character":a.push({type:"close_character"});break;case"puzzle":e?.puzzle&&!e.puzzle.solved&&(e.puzzle.options.forEach((n,s)=>{a.push({type:"puzzle_answer",answerIndex:s,answerText:n})}),a.push({type:"skip_puzzle",name:"Skip Puzzle"}));break;case"treasure":e?.interactables&&e.interactables.forEach((n,s)=>{n.used||a.push({type:"interact",interactableIndex:s,interactableName:n.name})}),a.push({type:"leave",name:"Leave Room"});break}return a}async executeAction(a){let{player:t,stats:e}=this.currentGameState;if(!t)throw new Error("No player");switch(a.type){case"move":return await this.moveToRoom(a.roomId),{type:"moved",success:!0,message:"Moved to new room"};case"basic_attack":return this.processCombatAction({type:"attack"});case"ability":return this.processCombatAction({type:"ability",abilityId:a.abilityId});case"use_item":return this.inventoryManager.useItem(t,a.itemId);case"equip_item":return this.inventoryManager.equipItem(t,a.itemId);case"unequip_item":return this.inventoryManager.unequipItem(t,a.slot);case"flee":return this.attemptFlee();case"rest":return t.rest(),this.currentGameState.phase="exploration",{type:"rested",success:!0,message:"You feel refreshed!"};case"accept_event":return this.executeEvent();case"buy_item":return this.shopManager.buyItem(t,this.getCurrentRoom(),a.itemId,this.currentGameState.stats);case"sell_item":return this.shopManager.sellItem(t,a.itemId,this.currentGameState.stats);case"puzzle_answer":{let n=this.getCurrentRoom(),s=this.puzzleManager.attemptAnswer(t,n,a.answerIndex,this.currentGameState.stats);return s.roomComplete&&n&&n.complete(),s.newPhase&&(this.currentGameState.phase=s.newPhase),s.result}case"skip_puzzle":{let n=this.getCurrentRoom(),s=this.puzzleManager.skipPuzzle(n);return s.roomComplete&&n&&n.complete(),s.newPhase&&(this.currentGameState.phase=s.newPhase),s.result}case"interact":{let n=this.interactionManager.interact(t,this.getCurrentRoom(),a.interactableIndex,this.currentGameState.stats);return n.playerDied&&this.handlePlayerDeath(),n.result}case"leave_shop":case"leave":return this.currentGameState.phase="exploration",{type:"left",success:!0,message:"You left the area"};case"restart":return{type:"restart_requested",success:!0,message:"Restart requested"};case"open_inventory":return this.previousPhase=this.currentGameState.phase,this.currentGameState.phase="inventory",{type:"inventory_opened",success:!0};case"close_inventory":return this.currentGameState.phase=this.previousPhase??"exploration",this.previousPhase=null,{type:"inventory_closed",success:!0};case"view_character":return this.previousPhase=this.currentGameState.phase,this.currentGameState.phase="character",{type:"character_viewed",success:!0};case"close_character":return this.currentGameState.phase=this.previousPhase??"exploration",this.previousPhase=null,{type:"character_closed",success:!0};case"view_stats":return{type:"stats_viewed",success:!0};case"quit":return{type:"quit_requested",success:!0};default:throw new Error(`Unknown action type: ${a.type}`)}}handlePlayerDeath(){return this.currentGameState.phase="game_over",this.currentGameState.combat=null,this.currentGameState}attemptFlee(){let a=this.getCurrentRoom();return a?a.type==="boss"?{type:"flee",success:!1,message:"Cannot flee from boss!"}:(y()?g().nextInt(1,100):Math.floor(Math.random()*100)+1)<=Ie?(this.currentGameState.phase="exploration",this.currentGameState.combat=null,{type:"flee",success:!0,message:"You escaped!"}):{type:"flee",success:!1,message:"Failed to escape!"}:{type:"flee",success:!1,message:"Cannot flee - no current room"}}executeEvent(){let a=this.getCurrentRoom(),t=this.currentGameState.player;if(!t)return{type:"event",success:!1,message:"Cannot execute event"};let e=this.eventManager.executeEvent(t,a,this.currentGameState.stats);return e.playerDied?this.currentGameState.phase="game_over":this.currentGameState.phase=e.newPhase,e.result}processCombatAction(a){let{player:t}=this.currentGameState;if(!t)throw new Error("No player");let e=this.getCurrentRoom();return!e||!e.enemies||e.enemies.length===0?{type:"combat_action",success:!1,message:"No enemies to fight"}:{type:"combat_action",success:!0,message:`Combat action '${a.type}' should be processed by GameLoop.CombatEngine`}}};v();var me={poison:"dot",burn:"dot",bleed:"dot",stun:"incapacitation",freeze:"incapacitation",sleep:"incapacitation",slow:"debuff",weaken:"debuff",vulnerable:"debuff",haste:"buff",strengthen:"buff",fortify:"buff",regeneration:"hot"};var X=class{constructor(a,t){this.player=a,this.enemies=[...t],this.state=this.initializeCombat()}initializeCombat(){return{round:1,currentTurnIndex:0,turnOrder:this.calculateTurnOrder(),status:"in_progress",log:["Combat begins! Round 1"]}}calculateTurnOrder(){let a=[];a.push({combatant:this.playerToCombatant(),initiative:this.player.getSpeed()});for(let t of this.enemies)a.push({combatant:this.enemyToCombatant(t),initiative:t.speed});return a.sort((t,e)=>e.initiative!==t.initiative?e.initiative-t.initiative:t.combatant.isPlayer?-1:e.combatant.isPlayer?1:0),a}playerToCombatant(){let a=this.state?.turnOrder.find(t=>t.combatant.isPlayer);return{id:this.player.id,name:this.player.name,health:this.player.stats.health,maxHealth:this.player.getMaxHealth(),speed:this.player.getSpeed(),defense:this.player.getDefense(),isPlayer:!0,statusEffects:a?.combatant.statusEffects??[]}}enemyToCombatant(a){let t=this.state?.turnOrder.find(e=>e.combatant.id===a.id);return{id:a.id,name:a.name,health:a.health,maxHealth:a.maxHealth,speed:a.speed,defense:a.defense,isPlayer:!1,statusEffects:t?.combatant.statusEffects??[]}}rollD20(){return y()?g().nextInt(1,20):Math.floor(Math.random()*20)+1}rollD100(){return y()?g().nextInt(1,100):Math.floor(Math.random()*100)+1}getPlayerAttackBonus(){let a=this.player.getAttackPower(),t=this.player.level;return Math.floor(a/5)+Math.floor(t/4)}getEnemyAttackBonus(a){return Math.floor(a.attackPower/5)+Math.floor(a.challengeRating/4)}rollAttack(a,t){let e=this.rollD20(),n=e+a,s=e===20,r=e===1,o;return s?o=!0:r?o=!1:o=n>=t,{roll:e,total:n,targetDefense:t,isHit:o,isNatural20:s,isNatural1:r}}calculateDamage(a,t,e,n,s,r){let o=t?D(t):D("1d4"),i=Math.floor(a/2),l=o+i,m=r;m||(m=this.rollD100()<=n),m&&(l=Math.floor(l*s));let d=Math.floor(e/2),u=Math.max(1,l-d);return{baseDamage:l,damageReduction:d,finalDamage:u,isCritical:m,critMultiplier:m?s:void 0}}applyStatusEffect(a,t,e,n,s,r){let o=this.state.turnOrder.find(b=>b.combatant.id===a);if(!o)return{applied:!1,refreshed:!1,upgraded:!1,message:"Target not found"};let i=o.combatant,l=me[t],m=this.getEffectDisplayName(t),d=r??this.calculateEffectValue(t,s,i.maxHealth),u=i.statusEffects.findIndex(b=>b.type===t);if(u!==-1){let b=i.statusEffects[u];b.remainingTurns=Math.max(b.remainingTurns,e);let R=!1;b.valuePerTurn!==void 0&&d>b.valuePerTurn&&(b.valuePerTurn=d,R=!0);let E=R?`${i.name}'s ${m} is upgraded and refreshed!`:`${i.name}'s ${m} duration refreshed.`;return this.state.log.push(E),{applied:!0,refreshed:!0,upgraded:R,message:E}}let f={id:crypto.randomUUID(),type:t,name:m,remainingTurns:e,source:n,sourceLevel:s};(l==="dot"||l==="hot")&&(f.valuePerTurn=d),(l==="buff"||l==="debuff")&&(f.percentModifier=this.getEffectModifier(t)),i.statusEffects.push(f);let h=`${i.name} is afflicted with ${m}!`;return this.state.log.push(h),{applied:!0,refreshed:!1,upgraded:!1,message:h}}removeStatusEffect(a,t){let e=this.state.turnOrder.find(r=>r.combatant.id===a);if(!e)return!1;let n=e.combatant.statusEffects.findIndex(r=>r.id===t);if(n===-1)return!1;let s=e.combatant.statusEffects.splice(n,1)[0];return this.state.log.push(`${e.combatant.name}'s ${s.name} has worn off.`),!0}removeEffectsByType(a,t){let e=this.state.turnOrder.find(s=>s.combatant.id===a);if(!e)return 0;let n=e.combatant.statusEffects.length;return e.combatant.statusEffects=e.combatant.statusEffects.filter(s=>s.type!==t),n-e.combatant.statusEffects.length}getStatusEffects(a){return this.state.turnOrder.find(e=>e.combatant.id===a)?.combatant.statusEffects??[]}hasStatusEffect(a,t){return this.getStatusEffects(a).some(e=>e.type===t)}isIncapacitated(a){return this.getStatusEffects(a).some(e=>me[e.type]==="incapacitation")}processStatusEffects(a){let t=this.state.turnOrder.find(l=>l.combatant.id===a);if(!t)return{processedEffects:[],dotDamage:0,hotHealing:0,expiredEffects:[],isIncapacitated:!1,messages:[]};let e=t.combatant,n=[],s=[],r=0,o=0,i=!1;for(let l of e.statusEffects){let m=me[l.type];m==="dot"&&l.valuePerTurn&&(r+=l.valuePerTurn,n.push(`${e.name} takes ${l.valuePerTurn} ${l.name} damage.`)),m==="hot"&&l.valuePerTurn&&(o+=l.valuePerTurn,n.push(`${e.name} regenerates ${l.valuePerTurn} health.`)),m==="incapacitation"&&(i=!0,n.push(`${e.name} is ${l.name.toLowerCase()} and cannot act!`)),l.remainingTurns--,l.remainingTurns<=0&&s.push(l)}for(let l of s){let m=e.statusEffects.findIndex(d=>d.id===l.id);m!==-1&&(e.statusEffects.splice(m,1),n.push(`${e.name}'s ${l.name} has worn off.`))}r>0&&this.applyDirectDamage(a,r),o>0&&this.applyDirectHealing(a,o);for(let l of n)this.state.log.push(l);return this.checkCombatEnd(),{processedEffects:[...e.statusEffects],dotDamage:r,hotHealing:o,expiredEffects:s,isIncapacitated:i,messages:n}}applyDirectDamage(a,t){let e=this.state.turnOrder.find(n=>n.combatant.id===a);if(e)if(e.combatant.isPlayer)this.player.stats.health=Math.max(0,this.player.stats.health-t),e.combatant.health=this.player.stats.health;else{let n=this.enemies.find(s=>s.id===a);n&&(n.health=Math.max(0,n.health-t),e.combatant.health=n.health,n.health<=0&&(this.state.log.push(`${e.combatant.name} succumbs to their wounds!`),this.removeDeadEnemy(a)))}}applyDirectHealing(a,t){let e=this.state.turnOrder.find(n=>n.combatant.id===a);if(e)if(e.combatant.isPlayer)this.player.heal(t),e.combatant.health=this.player.stats.health;else{let n=this.enemies.find(s=>s.id===a);n&&(n.health=Math.min(n.maxHealth,n.health+t),e.combatant.health=n.health)}}calculateEffectValue(a,t,e){switch(a){case"poison":return Math.max(1,Math.floor(e*.05));case"burn":return 3+2*t;case"bleed":return 5;case"regeneration":return 5+Math.floor(t/2);default:return 0}}getEffectModifier(a){switch(a){case"slow":return-50;case"weaken":return-25;case"vulnerable":return 25;case"haste":return 50;case"strengthen":return 25;case"fortify":return 25;default:return 0}}getEffectDisplayName(a){return{poison:"Poison",burn:"Burn",bleed:"Bleed",stun:"Stunned",freeze:"Frozen",sleep:"Asleep",slow:"Slowed",weaken:"Weakened",vulnerable:"Vulnerable",haste:"Haste",strengthen:"Strengthened",fortify:"Fortified",regeneration:"Regeneration"}[a]}getEffectiveAttackModifier(a){let t=this.getStatusEffects(a),e=0;for(let n of t)n.type==="weaken"&&n.percentModifier&&(e+=n.percentModifier),n.type==="strengthen"&&n.percentModifier&&(e+=n.percentModifier);return e}getDamageReceivedModifier(a){let t=this.getStatusEffects(a),e=1;for(let n of t)n.type==="vulnerable"&&n.percentModifier&&(e+=n.percentModifier/100),n.type==="fortify"&&n.percentModifier&&(e-=n.percentModifier/100);return Math.max(.25,e)}breakSleepOnDamage(a){let e=this.getStatusEffects(a).find(n=>n.type==="sleep");if(e){this.removeStatusEffect(a,e.id);let n=this.state.turnOrder.find(s=>s.combatant.id===a);n&&this.state.log.push(`${n.combatant.name} wakes up from the damage!`)}}playerAttack(a){let t=this.enemies.find(l=>l.id===a);if(!t)throw new Error(`Enemy with ID ${a} not found`);let e=this.playerToCombatant(),n=this.enemyToCombatant(t),s=this.getPlayerAttackBonus(),r=this.rollAttack(s,t.defense),o=null,i=!1;if(r.isHit){let l=this.player.equipment.weapon?.damage?.dice??null;o=this.calculateDamage(this.player.getAttackPower(),l,t.defense,this.player.getCritChance(),this.player.getCritMultiplier(),r.isNatural20);let m=this.getDamageReceivedModifier(t.id);o.finalDamage=Math.max(1,Math.floor(o.finalDamage*m)),this.breakSleepOnDamage(t.id),t.health=Math.max(0,t.health-o.finalDamage),i=t.health<=0,this.updateCombatantHealth(t.id,t.health),o.isCritical?this.state.log.push(`${e.name} CRITICALLY hits ${n.name} for ${o.finalDamage} damage!`):this.state.log.push(`${e.name} hits ${n.name} for ${o.finalDamage} damage.`),i&&(this.state.log.push(`${n.name} is defeated!`),this.removeDeadEnemy(t.id))}else r.isNatural1?this.state.log.push(`${e.name} critically misses ${n.name}!`):this.state.log.push(`${e.name} misses ${n.name}.`);return this.checkCombatEnd(),{attacker:e,defender:n,attackRoll:r,damage:o,defenderDied:i}}playerUseAbility(a,t){let e=this.player.getAllAbilities().find(i=>i.id===a);if(!e)return{abilityName:"Unknown",success:!1,enemiesKilled:[],message:"Ability not found"};if(e.currentCooldown>0)return{abilityName:e.name,success:!1,enemiesKilled:[],message:`${e.name} is on cooldown (${e.currentCooldown} turns remaining)`};if(this.player.stats.mana<e.manaCost)return{abilityName:e.name,success:!1,enemiesKilled:[],message:`Not enough mana for ${e.name} (need ${e.manaCost}, have ${this.player.stats.mana})`};this.player.useMana(e.manaCost),e.currentCooldown=e.cooldown;let n=[],s=0,r=0,o="";if(e.healing){let i=Math.floor(this.player.getMaxHealth()*e.healing);return r=this.player.heal(i),o=`${this.player.name} uses ${e.name} and heals for ${r} HP!`,this.state.log.push(o),{abilityName:e.name,success:!0,healing:r,enemiesKilled:[],message:o}}if(e.effect==="attack_buff"){let i=Math.floor(this.player.stats.attack*.25);return this.player.applyBuff(e.name,{attack:i},3),o=`${this.player.name} uses ${e.name}, increasing attack by ${i} for 3 turns!`,this.state.log.push(o),{abilityName:e.name,success:!0,effectApplied:"attack_buff",enemiesKilled:[],message:o}}if(e.effect==="lifesteal"&&e.damage&&t){let i=this.enemies.find(d=>d.id===t);if(!i)return{abilityName:e.name,success:!1,enemiesKilled:[],message:"Target not found"};let l=e.damage+Math.floor(this.player.level*.8),m=this.getDamageReceivedModifier(i.id);return s=Math.max(1,Math.floor(l*m)),i.health=Math.max(0,i.health-s),this.updateCombatantHealth(i.id,i.health),r=this.player.heal(Math.floor(s*.4)),this.state.log.push(`${e.name} drains ${i.name} for ${s} damage!`),this.state.log.push(`${this.player.name} heals for ${r} HP!`),i.health<=0&&(n.push(i.id),this.state.log.push(`${i.name} is defeated!`),this.removeDeadEnemy(i.id)),o=`${this.player.name} uses ${e.name}, dealing ${s} damage and healing for ${r}!`,this.checkCombatEnd(),{abilityName:e.name,success:!0,damage:s,healing:r,effectApplied:"lifesteal",enemiesKilled:n,message:o}}if(e.effect==="debuff"&&t){let i=this.enemies.find(l=>l.id===t);return i?(this.applyStatusEffect(i.id,"vulnerable",3,e.name,this.player.level,20),o=`${this.player.name} uses ${e.name} on ${i.name}! They take 20% more damage for 3 turns!`,this.state.log.push(o),{abilityName:e.name,success:!0,effectApplied:"debuff",enemiesKilled:[],message:o}):{abilityName:e.name,success:!1,enemiesKilled:[],message:"Target not found"}}if(e.effect==="mana_restore"){let i=Math.floor(this.player.stats.health*.15),l=Math.floor(this.player.getMaxMana()*.3);if(this.player.stats.health<=i)return{abilityName:e.name,success:!1,enemiesKilled:[],message:`Not enough health to use ${e.name}!`};this.player.stats.health-=i;let m=this.player.restoreMana(l);return this.updateCombatantHealth(this.player.id,this.player.stats.health),o=`${this.player.name} uses ${e.name}, sacrificing ${i} HP to restore ${m} mana!`,this.state.log.push(o),{abilityName:e.name,success:!0,damage:i,effectApplied:"mana_restore",enemiesKilled:[],message:o}}if(e.effect==="consume_shards"){let i=this.player;if(i.soulShards===void 0||i.soulShards===0)return{abilityName:e.name,success:!1,enemiesKilled:[],message:"No soul shards to consume!"};let l=i.soulShards,d=((e.damage??10)+Math.floor(this.player.level*1.5))*l;i.soulShards=0;let u=t?this.enemies.find(h=>h.id===t):this.enemies[0];if(!u)return{abilityName:e.name,success:!1,enemiesKilled:[],message:"No target available"};let f=this.getDamageReceivedModifier(u.id);return s=Math.max(1,Math.floor(d*f)),u.health=Math.max(0,u.health-s),this.updateCombatantHealth(u.id,u.health),this.state.log.push(`${e.name} consumes ${l} soul shards!`),this.state.log.push(`${e.name} hits ${u.name} for ${s} damage!`),u.health<=0&&(n.push(u.id),this.state.log.push(`${u.name} is defeated!`),this.removeDeadEnemy(u.id)),o=`${this.player.name} uses ${e.name}, consuming ${l} shards for ${s} damage!`,this.checkCombatEnd(),{abilityName:e.name,success:!0,damage:s,effectApplied:"consume_shards",enemiesKilled:n,message:o}}if(e.effect==="full_restore"){this.player.stats.health=this.player.getMaxHealth(),this.player.stats.mana=this.player.getMaxMana();for(let i of this.player.abilities)i.currentCooldown=0;return o=`${this.player.name} uses ${e.name}! Fully restored health, mana, and cooldowns!`,this.state.log.push(o),{abilityName:e.name,success:!0,healing:this.player.getMaxHealth(),effectApplied:"full_restore",enemiesKilled:[],message:o}}if(e.effect==="invulnerable"||e.effect==="magic_immunity")return this.player.applyBuff(e.name,{defense:999},1),o=`${this.player.name} uses ${e.name} and becomes temporarily invulnerable!`,this.state.log.push(o),{abilityName:e.name,success:!0,effectApplied:e.effect,enemiesKilled:[],message:o};if(e.effect==="aoe"||e.isAoe){let i=e.damage??Math.floor(this.player.basicAttack().damage*.8),l=this.enemies.filter(m=>m.health>0);for(let m of l){let d=this.getDamageReceivedModifier(m.id),u=Math.max(1,Math.floor(i*d));m.health=Math.max(0,m.health-u),s+=u,this.state.log.push(`${e.name} hits ${m.name} for ${u} damage!`),m.health<=0&&(n.push(m.id),this.state.log.push(`${m.name} is defeated!`))}for(let m of n)this.removeDeadEnemy(m);return o=`${this.player.name} uses ${e.name}, dealing ${s} total damage to all enemies!`,this.checkCombatEnd(),{abilityName:e.name,success:!0,damage:s,isAoe:!0,enemiesKilled:n,message:o}}if(e.damage&&e.healing&&t){let i=this.enemies.find(m=>m.id===t);if(!i)return{abilityName:e.name,success:!1,enemiesKilled:[],message:"Target not found"};let l=this.getDamageReceivedModifier(i.id);return s=Math.max(1,Math.floor(e.damage*l)),i.health=Math.max(0,i.health-s),r=this.player.heal(e.healing),this.state.log.push(`${e.name} drains ${i.name} for ${s} damage!`),this.state.log.push(`${this.player.name} heals for ${r} HP!`),i.health<=0&&(n.push(i.id),this.state.log.push(`${i.name} is defeated!`),this.removeDeadEnemy(i.id)),o=`${this.player.name} uses ${e.name}, dealing ${s} damage and healing for ${r}!`,this.checkCombatEnd(),{abilityName:e.name,success:!0,damage:s,healing:r,enemiesKilled:n,message:o}}if(e.damage&&t){let i=this.enemies.find(d=>d.id===t);if(!i)return{abilityName:e.name,success:!1,enemiesKilled:[],message:"Target not found"};let l;if(e.damage<5){let d=this.player.basicAttack().damage;l=Math.floor(d*e.damage)}else{l=e.damage+Math.floor(this.player.level*1.2);let d=this.player;if(d.soulShards!==void 0&&d.soulShards>0&&e.id==="shadow_bolt"){let u=d.soulShards*4;l+=u,this.state.log.push(`Soul shards add ${u} bonus damage!`),d.soulShards=0}}let m=this.getDamageReceivedModifier(i.id);return s=Math.max(1,Math.floor(l*m)),e.effect==="stun"&&(this.applyStatusEffect(i.id,"stun",1,e.name,this.player.level),this.state.log.push(`${i.name} is stunned!`)),i.health=Math.max(0,i.health-s),this.state.log.push(`${e.name} hits ${i.name} for ${s} damage!`),i.health<=0&&(n.push(i.id),this.state.log.push(`${i.name} is defeated!`),this.removeDeadEnemy(i.id)),o=`${this.player.name} uses ${e.name} on ${i.name} for ${s} damage!`,this.checkCombatEnd(),{abilityName:e.name,success:!0,damage:s,effectApplied:e.effect,enemiesKilled:n,message:o}}return o=`${this.player.name} uses ${e.name}!`,this.state.log.push(o),{abilityName:e.name,success:!0,enemiesKilled:[],message:o}}enemyAttack(a){let t=this.enemies.find(l=>l.id===a);if(!t)throw new Error(`Enemy with ID ${a} not found`);let e=this.enemyToCombatant(t),n=this.playerToCombatant(),s=this.getEnemyAttackBonus(t),r=this.rollAttack(s,this.player.getDefense()),o=null,i=!1;if(r.isHit){let l=this.getEnemyDamageDice(t);o=this.calculateDamage(t.attackPower,l,this.player.getDefense(),10,1.5,r.isNatural20);let m=this.getDamageReceivedModifier(this.player.id);o.finalDamage=Math.max(1,Math.floor(o.finalDamage*m)),this.breakSleepOnDamage(this.player.id),this.player.takeDamage(o.finalDamage),i=!this.player.isAlive(),this.updateCombatantHealth(this.player.id,this.player.stats.health),o.isCritical?this.state.log.push(`${e.name} CRITICALLY hits ${n.name} for ${o.finalDamage} damage!`):this.state.log.push(`${e.name} hits ${n.name} for ${o.finalDamage} damage.`),i&&this.state.log.push(`${n.name} has fallen!`)}else r.isNatural1?this.state.log.push(`${e.name} critically misses ${n.name}!`):this.state.log.push(`${e.name} misses ${n.name}.`);return this.checkCombatEnd(),{attacker:e,defender:n,attackRoll:r,damage:o,defenderDied:i}}getEnemyDamageDice(a){let t=a.challengeRating;return t<=.5?"1d4":t<=1?"1d6":t<=2?"1d8":t<=4?"1d10":t<=8?"2d6":t<=12?"2d8":t<=16?"2d10":"2d12"}getCurrentTurn(){return this.state.status!=="in_progress"?null:this.state.turnOrder[this.state.currentTurnIndex]??null}startTurn(){let a=this.getCurrentTurn();return a?(a.combatant.isPlayer&&this.player.endTurn(),this.processStatusEffects(a.combatant.id)):{processedEffects:[],dotDamage:0,hotHealing:0,expiredEffects:[],isIncapacitated:!1,messages:["No current turn"]}}nextTurn(){return this.state.status!=="in_progress"?null:(this.state.currentTurnIndex++,this.state.currentTurnIndex>=this.state.turnOrder.length&&(this.state.currentTurnIndex=0,this.state.round++,this.state.log.push(`Round ${this.state.round}`)),this.getCurrentTurn())}updateCombatantHealth(a,t){let e=this.state.turnOrder.find(n=>n.combatant.id===a);e&&(e.combatant.health=t)}removeDeadEnemy(a){let t=this.player;t.gainSoulShard&&t.gainSoulShard()&&this.state.log.push(`${this.player.name} gains a soul shard! (${t.soulShards}/${t.maxSoulShards})`);let e=this.enemies.findIndex(s=>s.id===a);e!==-1&&this.enemies.splice(e,1);let n=this.state.turnOrder.findIndex(s=>s.combatant.id===a);n!==-1&&(this.state.turnOrder.splice(n,1),n<this.state.currentTurnIndex?this.state.currentTurnIndex--:n===this.state.currentTurnIndex&&this.state.currentTurnIndex--)}checkCombatEnd(){this.player.isAlive()?this.enemies.length===0&&(this.state.status="victory",this.state.log.push("VICTORY - All enemies defeated!")):(this.state.status="defeat",this.state.log.push("DEFEAT - You have been slain!"))}getState(){return{...this.state}}getStatus(){return this.state.status}getLog(){return[...this.state.log]}getEnemies(){return[...this.enemies]}isPlayerTurn(){return this.getCurrentTurn()?.combatant.isPlayer??!1}getValidTargets(){return this.enemies.map(a=>a.id)}};v();var pt=new Set(["open_inventory","close_inventory","view_character","close_character","equip_item","unequip_item"]),j=class{constructor(){this.combatEngine=null;this.isRunning=!1;this.gameManager=new K}async startGame(a,t=ue(10)){this.gameManager.startNewGame(a.playerClass,a.name,t),this.isRunning=!0,await this.mainLoop()}async mainLoop(){for(;this.isRunning;){let a=this.gameManager.getState();if(a.phase==="game_over"){this.handleGameOver();break}if(a.phase==="victory"){this.handleVictory();break}this.render(a);let t=this.gameManager.getAvailableActions();this.displayActions(t);let e=await this.getPlayerInput(t),n=await this.gameManager.executeAction(e);this.displayResult(n);let s=this.gameManager.getState();await this.handlePhaseTransition(s.phase)}}async handlePhaseTransition(a){switch(a){case"combat":this.initializeCombat(),await this.runCombatLoop(),this.handleCombatEnd();break;case"exploration":this.handleExploration();break;case"shop":this.handleShop();break;case"event":this.handleEvent();break;case"rest":this.handleRest();break;case"inventory":this.handleInventory();break;case"character":this.handleCharacter();break}}handleCombatEnd(){if(!this.combatEngine)return;let a=this.combatEngine.getStatus();if(a==="victory"){this.gameManager.completeRoom();let t=this.gameManager.getAndClearLastRewards();t&&this.displayRoomRewards(t)}else a==="defeat"&&this.gameManager.handlePlayerDeath();this.combatEngine=null}displayRoomRewards(a){console.log("Room Rewards:",a)}initializeCombat(){let a=this.gameManager.getState(),t=a.player;if(!t)throw new Error("Cannot initialize combat: Player not found");let e=a.dungeon.currentRoomId;if(!e)throw new Error("Cannot initialize combat: No current room");let n=a.dungeon.rooms.get(e);if(!n)throw new Error(`Cannot initialize combat: Room ${e} not found`);let s=n.enemies??[];if(s.length===0)throw new Error("Cannot initialize combat: No enemies in room");this.combatEngine=new X(t,s)}async runCombatLoop(){if(this.combatEngine)for(;this.combatEngine.getStatus()==="in_progress";){let a=this.combatEngine.startTurn();if(this.displayStatusEffectMessages(a.messages),this.combatEngine.getStatus()!=="in_progress")break;if(a.isIncapacitated){this.combatEngine.nextTurn();continue}let t=this.combatEngine.getCurrentTurn();if(!t)break;if(t.combatant.isPlayer){if(!await this.handlePlayerCombatTurn())break}else this.handleEnemyCombatTurn(t.combatant.id);if(this.combatEngine.getStatus()!=="in_progress")break;this.displayCombatState(),this.combatEngine.nextTurn()}}async handlePlayerCombatTurn(){if(!this.combatEngine)return!1;for(;;){this.displayCombatState();let a=this.gameManager.getAvailableActions();this.displayActions(a);let t=await this.getPlayerInput(a);if(pt.has(t.type)){let n=await this.gameManager.executeAction(t);this.displayResult(n);continue}return await this.executeCombatAction(t)}}async executeCombatAction(a){if(!this.combatEngine)return!1;switch(a.type){case"basic_attack":{let t=this.combatEngine.getValidTargets(),e;t.length===1?e=t[0]:e=await this.getTargetSelection(t);let n=this.combatEngine.playerAttack(e);return this.displayAttackResult(n),!0}case"ability":{let t=a.abilityId,e=this.gameManager.getState().player?.getAllAbilities().find(o=>o.id===t),n=e?.damage&&e?.effect!=="aoe",s;if(n){let o=this.combatEngine.getValidTargets();o.length===1?s=o[0]:o.length>1&&(s=await this.getTargetSelection(o))}let r=this.combatEngine.playerUseAbility(t,s);return this.displayAbilityResult(r),!0}case"use_item":{let t=await this.gameManager.executeAction(a);return this.displayResult(t),!0}case"flee":{let t=await this.gameManager.executeAction(a);return this.displayResult(t),!t.success}default:{let t=await this.gameManager.executeAction(a);return this.displayResult(t),!0}}}handleEnemyCombatTurn(a){if(!this.combatEngine)return;let t=this.combatEngine.enemyAttack(a);this.displayAttackResult(t)}async getPlayerInput(a){throw new Error("getPlayerInput must be implemented by UI layer")}async getTargetSelection(a){throw new Error("getTargetSelection must be implemented by UI layer")}render(a){}displayActions(a){}displayResult(a){}displayCombatState(){}displayStatusEffectMessages(a){}displayAttackResult(a){}displayAbilityResult(a){}handleGameOver(){this.isRunning=!1}handleVictory(){this.isRunning=!1}handleExploration(){}handleShop(){}handleEvent(){}handleRest(){}handleInventory(){}handleCharacter(){}getState(){return this.gameManager.getState()}getCombatEngine(){return this.combatEngine}};var Y={warrior:{primary:"#c0392b",secondary:"#e74c3c",accent:"#f39c12"},mage:{primary:"#8e44ad",secondary:"#9b59b6",accent:"#3498db"},rogue:{primary:"#27ae60",secondary:"#2ecc71",accent:"#1abc9c"},cleric:{primary:"#f1c40f",secondary:"#f39c12",accent:"#ecf0f1"},warlock:{primary:"#2c3e50",secondary:"#34495e",accent:"#9b59b6"},aberration:{primary:"#6c3483",secondary:"#8e44ad",accent:"#e8daef"},beast:{primary:"#784212",secondary:"#a04000",accent:"#f5b041"},celestial:{primary:"#f4d03f",secondary:"#f7dc6f",accent:"#fcf3cf"},construct:{primary:"#566573",secondary:"#7f8c8d",accent:"#bdc3c7"},dragon:{primary:"#b03a2e",secondary:"#cb4335",accent:"#f9e79f"},elemental:{primary:"#2e86ab",secondary:"#17a2b8",accent:"#a2d9ce"},fey:{primary:"#76d7c4",secondary:"#48c9b0",accent:"#f5b7b1"},fiend:{primary:"#922b21",secondary:"#c0392b",accent:"#f1948a"},giant:{primary:"#5d6d7e",secondary:"#85929e",accent:"#d5dbdb"},humanoid:{primary:"#d4ac0d",secondary:"#f1c40f",accent:"#fdebd0"},monstrosity:{primary:"#1e8449",secondary:"#28b463",accent:"#abebc6"},ooze:{primary:"#239b56",secondary:"#58d68d",accent:"#abebc6"},plant:{primary:"#196f3d",secondary:"#27ae60",accent:"#82e0aa"},undead:{primary:"#1c2833",secondary:"#2c3e50",accent:"#85929e"},common:{primary:"#95a5a6",secondary:"#bdc3c7",accent:"#ecf0f1"},uncommon:{primary:"#27ae60",secondary:"#2ecc71",accent:"#82e0aa"},rare:{primary:"#2980b9",secondary:"#3498db",accent:"#85c1e9"},veryRare:{primary:"#8e44ad",secondary:"#9b59b6",accent:"#d7bde2"},legendary:{primary:"#d35400",secondary:"#e67e22",accent:"#f9e79f"}};function Oe(c,a=64){let t=c.toLowerCase(),e=Y[t]||Y.warrior,n;switch(t){case"mage":n=`
                <circle cx="32" cy="16" r="8" fill="${e.secondary}"/>
                <path d="M24 24 L20 56 L28 56 L30 40 L34 40 L36 56 L44 56 L40 24 Z" fill="${e.primary}"/>
                <line x1="44" y1="20" x2="52" y2="8" stroke="${e.accent}" stroke-width="3"/>
                <circle cx="52" cy="6" r="4" fill="${e.accent}"/>
            `;break;case"rogue":n=`
                <path d="M26 8 L32 4 L38 8 L36 18 L28 18 Z" fill="${e.secondary}"/>
                <circle cx="32" cy="14" r="6" fill="${e.secondary}"/>
                <path d="M24 20 L20 54 L28 54 L30 36 L34 36 L36 54 L44 54 L40 20 Z" fill="${e.primary}"/>
                <path d="M16 30 L12 42 L18 40 Z" fill="${e.accent}"/>
                <path d="M48 30 L52 42 L46 40 Z" fill="${e.accent}"/>
            `;break;case"cleric":n=`
                <circle cx="32" cy="14" r="8" fill="${e.secondary}"/>
                <path d="M22 22 L18 56 L28 56 L30 38 L34 38 L36 56 L46 56 L42 22 Z" fill="${e.primary}"/>
                <rect x="29" y="26" width="6" height="14" fill="${e.accent}"/>
                <rect x="26" y="30" width="12" height="4" fill="${e.accent}"/>
            `;break;case"warlock":n=`
                <circle cx="32" cy="14" r="8" fill="${e.secondary}"/>
                <path d="M22 22 L18 58 L46 58 L42 22 Z" fill="${e.primary}"/>
                <ellipse cx="32" cy="38" rx="6" ry="8" fill="${e.accent}" opacity="0.7"/>
                <circle cx="32" cy="38" r="3" fill="${e.accent}"/>
            `;break;default:n=`
                <circle cx="32" cy="14" r="8" fill="${e.secondary}"/>
                <rect x="24" y="22" width="16" height="20" fill="${e.primary}" rx="2"/>
                <rect x="22" y="42" width="8" height="14" fill="${e.primary}"/>
                <rect x="34" y="42" width="8" height="14" fill="${e.primary}"/>
                <rect x="46" y="16" width="4" height="28" fill="${e.accent}"/>
                <rect x="44" y="14" width="8" height="4" fill="${e.accent}"/>
            `}let s=`
        <svg xmlns="http://www.w3.org/2000/svg" width="${a}" height="${a}" viewBox="0 0 64 64">
            <rect width="64" height="64" fill="#1a1a2e" rx="8"/>
            ${n}
        </svg>
    `.trim();return`data:image/svg+xml,${encodeURIComponent(s)}`}function Le(c,a,t=64){let e=c.toLowerCase(),s=Y[e]||Y.humanoid,r;switch(e){case"aberration":r=`
                <ellipse cx="32" cy="28" rx="16" ry="12" fill="${s.primary}"/>
                <circle cx="32" cy="26" r="6" fill="${s.accent}"/>
                <circle cx="32" cy="26" r="3" fill="#1a1a2e"/>
                <path d="M18 36 Q12 48 8 52" stroke="${s.secondary}" stroke-width="4" fill="none"/>
                <path d="M26 38 Q22 50 18 56" stroke="${s.secondary}" stroke-width="4" fill="none"/>
                <path d="M38 38 Q42 50 46 56" stroke="${s.secondary}" stroke-width="4" fill="none"/>
                <path d="M46 36 Q52 48 56 52" stroke="${s.secondary}" stroke-width="4" fill="none"/>
            `;break;case"beast":r=`
                <ellipse cx="32" cy="28" rx="18" ry="10" fill="${s.primary}"/>
                <circle cx="46" cy="22" r="8" fill="${s.primary}"/>
                <circle cx="48" cy="20" r="2" fill="${s.accent}"/>
                <rect x="14" y="34" width="6" height="16" fill="${s.secondary}" rx="2"/>
                <rect x="24" y="34" width="6" height="16" fill="${s.secondary}" rx="2"/>
                <rect x="34" y="34" width="6" height="16" fill="${s.secondary}" rx="2"/>
                <rect x="44" y="34" width="6" height="16" fill="${s.secondary}" rx="2"/>
            `;break;case"dragon":r=`
                <path d="M8 20 L32 8 L56 20 L32 32 Z" fill="${s.secondary}" opacity="0.7"/>
                <ellipse cx="32" cy="36" rx="14" ry="10" fill="${s.primary}"/>
                <path d="M18 36 L8 44 L18 42 Z" fill="${s.primary}"/>
                <circle cx="26" cy="34" r="3" fill="${s.accent}"/>
                <circle cx="38" cy="34" r="3" fill="${s.accent}"/>
                <path d="M28 44 L32 52 L36 44" stroke="${s.accent}" stroke-width="2" fill="none"/>
            `;break;case"undead":r=`
                <ellipse cx="32" cy="28" rx="14" ry="16" fill="${s.secondary}"/>
                <ellipse cx="26" cy="26" rx="4" ry="5" fill="#1a1a2e"/>
                <ellipse cx="38" cy="26" rx="4" ry="5" fill="#1a1a2e"/>
                <circle cx="26" cy="26" r="2" fill="${s.accent}"/>
                <circle cx="38" cy="26" r="2" fill="${s.accent}"/>
                <path d="M26 40 L28 44 L30 40 L32 44 L34 40 L36 44 L38 40" stroke="#1a1a2e" stroke-width="2" fill="none"/>
                <ellipse cx="32" cy="34" rx="2" ry="3" fill="#1a1a2e"/>
            `;break;case"fiend":r=`
                <path d="M20 16 L24 28 L20 28 Z" fill="${s.accent}"/>
                <path d="M44 16 L40 28 L44 28 Z" fill="${s.accent}"/>
                <ellipse cx="32" cy="32" rx="12" ry="14" fill="${s.primary}"/>
                <circle cx="27" cy="30" r="3" fill="${s.accent}"/>
                <circle cx="37" cy="30" r="3" fill="${s.accent}"/>
                <path d="M26 40 Q32 46 38 40" stroke="${s.secondary}" stroke-width="2" fill="none"/>
            `;break;case"elemental":r=`
                <circle cx="32" cy="32" r="18" fill="${s.primary}" opacity="0.6"/>
                <circle cx="32" cy="32" r="12" fill="${s.secondary}" opacity="0.7"/>
                <circle cx="32" cy="32" r="6" fill="${s.accent}"/>
                <path d="M32 14 Q44 20 32 32 Q20 44 32 50" stroke="${s.accent}" stroke-width="2" fill="none"/>
            `;break;case"construct":r=`
                <rect x="22" y="16" width="20" height="14" fill="${s.primary}" rx="2"/>
                <rect x="20" y="32" width="24" height="20" fill="${s.secondary}" rx="2"/>
                <rect x="26" y="20" width="4" height="4" fill="${s.accent}"/>
                <rect x="34" y="20" width="4" height="4" fill="${s.accent}"/>
                <rect x="28" y="38" width="8" height="8" fill="${s.primary}"/>
            `;break;case"giant":r=`
                <circle cx="32" cy="16" r="10" fill="${s.secondary}"/>
                <rect x="20" y="26" width="24" height="24" fill="${s.primary}" rx="4"/>
                <rect x="12" y="28" width="8" height="18" fill="${s.secondary}" rx="2"/>
                <rect x="44" y="28" width="8" height="18" fill="${s.secondary}" rx="2"/>
                <circle cx="28" cy="14" r="2" fill="${s.accent}"/>
                <circle cx="36" cy="14" r="2" fill="${s.accent}"/>
            `;break;case"ooze":r=`
                <ellipse cx="32" cy="38" rx="22" ry="14" fill="${s.primary}" opacity="0.8"/>
                <ellipse cx="28" cy="36" rx="14" ry="10" fill="${s.secondary}" opacity="0.6"/>
                <circle cx="24" cy="34" r="3" fill="${s.accent}"/>
                <circle cx="38" cy="38" r="2" fill="${s.accent}"/>
            `;break;default:r=`
                <circle cx="32" cy="16" r="8" fill="${s.secondary}"/>
                <rect x="24" y="24" width="16" height="18" fill="${s.primary}" rx="2"/>
                <rect x="14" y="26" width="8" height="14" fill="${s.secondary}" rx="2"/>
                <rect x="42" y="26" width="8" height="14" fill="${s.secondary}" rx="2"/>
                <rect x="24" y="42" width="6" height="12" fill="${s.secondary}" rx="2"/>
                <rect x="34" y="42" width="6" height="12" fill="${s.secondary}" rx="2"/>
                <circle cx="28" cy="14" r="2" fill="${s.accent}"/>
                <circle cx="36" cy="14" r="2" fill="${s.accent}"/>
            `}let o=`
        <svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${t}" viewBox="0 0 64 64">
            <rect width="64" height="64" fill="#1a1a2e" rx="8"/>
            ${r}
        </svg>
    `.trim();return`data:image/svg+xml,${encodeURIComponent(o)}`}function O(c,a="common",t=48){let e=c.toLowerCase(),n=a.toLowerCase().replace("_",""),s;switch(n){case"uncommon":s="uncommon";break;case"rare":s="rare";break;case"veryrare":s="veryRare";break;case"legendary":s="legendary";break;default:s="common"}let r=Y[s],o;switch(e){case"weapon":o=`
                <rect x="22" y="6" width="4" height="28" fill="${r.primary}" rx="1"/>
                <rect x="16" y="32" width="16" height="4" fill="${r.secondary}" rx="1"/>
                <rect x="22" y="36" width="4" height="10" fill="${r.accent}" rx="1"/>
            `;break;case"armor":o=`
                <path d="M14 14 L24 8 L34 14 L34 36 L24 42 L14 36 Z" fill="${r.primary}"/>
                <path d="M18 18 L24 14 L30 18 L30 30 L24 34 L18 30 Z" fill="${r.secondary}"/>
                <circle cx="24" cy="24" r="3" fill="${r.accent}"/>
            `;break;case"accessory":o=`
                <circle cx="24" cy="24" r="12" fill="none" stroke="${r.primary}" stroke-width="6"/>
                <circle cx="24" cy="12" r="4" fill="${r.accent}"/>
            `;break;case"consumable":o=`
                <rect x="20" y="6" width="8" height="6" fill="${r.secondary}" rx="1"/>
                <path d="M18 12 L14 38 Q14 44 24 44 Q34 44 34 38 L30 12 Z" fill="${r.primary}"/>
                <ellipse cx="24" cy="30" rx="6" ry="8" fill="${r.accent}" opacity="0.7"/>
            `;break;case"treasure":o=`
                <ellipse cx="20" cy="28" rx="10" ry="6" fill="${r.accent}"/>
                <ellipse cx="28" cy="24" rx="10" ry="6" fill="${r.primary}"/>
                <ellipse cx="24" cy="20" rx="10" ry="6" fill="${r.secondary}"/>
                <text x="24" y="24" font-size="8" fill="${r.accent}" text-anchor="middle">G</text>
            `;break;default:o=`
                <rect x="10" y="14" width="28" height="24" fill="${r.primary}" rx="2"/>
                <rect x="14" y="18" width="20" height="16" fill="${r.secondary}" rx="1"/>
                <text x="24" y="30" font-size="10" fill="${r.accent}" text-anchor="middle">?</text>
            `}let i="";n!=="common"&&(i=`<rect width="48" height="48" fill="none" stroke="${r.accent}" stroke-width="2" rx="6" opacity="0.6"/>`);let l=`
        <svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${t}" viewBox="0 0 48 48">
            <rect width="48" height="48" fill="#16213e" rx="6"/>
            ${i}
            ${o}
        </svg>
    `.trim();return`data:image/svg+xml,${encodeURIComponent(l)}`}var Q=class extends j{constructor(t="game-container"){super();this.actionResolver=null;this.targetResolver=null;this.messageLog=[];let e=document.getElementById(t);if(!e)throw new Error(`Container element '${t}' not found`);this.container=e,this.setupKeyboardControls()}formatName(t,e){return`<span class="log-${e}">${t}</span>`}formatItemName(t,e){return`<span class="${e?`log-item-${e.toLowerCase().replace("_","")}`:"log-item"}">${t}</span>`}formatEventMessage(t){let e=t,n=t.match(/You found (.+?)!/);if(n){let d=n[1],u="log-item-rare";t.toLowerCase().includes("legendary")||t.toLowerCase().includes("ancient")?u="log-item-legendary":t.toLowerCase().includes("uncommon")||t.toLowerCase().includes("minor")?u="log-item-uncommon":(t.toLowerCase().includes("common")||t.toLowerCase().includes("basic"))&&(u="log-item-common"),e=e.replace(`You found ${d}!`,`You found <span class="${u}">${d}</span>!`)}let s=t.match(/Received (.+?)(?:\.|!|$)/);if(s){let d=s[1];e=e.replace(`Received ${d}`,`Received <span class="log-item-rare">${d}</span>`)}let r=t.match(/(\d+)\s*gold/gi);r&&r.forEach(d=>{let u=d.match(/\d+/)?.[0];u&&(e=e.replace(d,`<span class="log-gold">${u} gold</span>`))});let o=t.match(/healed?\s+(?:for\s+)?(\d+)/gi);o&&o.forEach(d=>{let u=d.match(/\d+/)?.[0];u&&(e=e.replace(d,`<span class="log-heal">healed ${u}</span>`))});let i=t.match(/(?:took|deals?|suffer(?:ed)?)\s+(\d+)\s*(?:damage)?/gi);i&&i.forEach(d=>{e=e.replace(d,`<span class="log-damage">${d}</span>`)});let l=t.match(/[+-]\d+\s+(?:attack|defense|speed|health|mana|crit)/gi);l&&l.forEach(d=>{let f=d.startsWith("+")?"log-heal":"log-damage";e=e.replace(d,`<span class="${f}">${d}</span>`)});let m=t.match(/(?:gained|received|afflicted with)\s+["']?([A-Z][a-zA-Z\s]+?)["']?(?:\s+for|\.|!|$)/);if(m){let d=m[1].trim();e=e.replace(d,`<span class="log-ability">${d}</span>`)}return e}setupKeyboardControls(){document.addEventListener("keydown",t=>{if(t.key>="1"&&t.key<="9"){let e=parseInt(t.key)-1;this.selectActionByIndex(e)}t.key==="Escape"&&this.handleEscape()})}selectActionByIndex(t){let e=this.container.querySelectorAll(".action-btn");t<e.length&&e[t].click()}handleEscape(){let t=this.container.querySelector(".modal");t&&t.remove()}async getPlayerInput(t){return new Promise(e=>{this.actionResolver=e,this.renderActionButtons(t)})}async getTargetSelection(t){return new Promise(e=>{this.targetResolver=e,this.renderTargetSelection(t)})}render(t){try{this.container.innerHTML="",this.container.appendChild(this.createGameLayout(t)),t.phase==="inventory"&&this.container.appendChild(this.createInventoryOverlay(t)),t.phase==="character"&&this.container.appendChild(this.createCharacterOverlay(t))}catch(e){this.renderError(e,t)}}renderError(t,e){let n=t instanceof Error?t.message:"Unknown error",s=t instanceof Error?t.stack:"";console.error("Render error:",t),this.container.innerHTML=`
            <div class="error-screen">
                <h1 class="error-title">Something went wrong</h1>
                <p class="error-message">${this.escapeHtml(n)}</p>
                <details class="error-details">
                    <summary>Technical Details</summary>
                    <pre>${this.escapeHtml(s||"No stack trace available")}</pre>
                    <p>Game Phase: ${e.phase}</p>
                    <p>Current Room: ${e.dungeon.currentRoomId||"None"}</p>
                    <p>Seed: ${e.seed}</p>
                </details>
                <div class="error-actions">
                    <button class="error-btn" onclick="location.reload()">Restart Game</button>
                </div>
            </div>
        `}escapeHtml(t){let e=document.createElement("div");return e.textContent=t,e.innerHTML}createGameLayout(t){let e=document.createElement("div");e.className="game-layout";let n=this.createPlayerSidebar(t);e.appendChild(n);let s=document.createElement("main");s.className="game-main";let r=this.getCurrentRoom(t);t.phase==="combat"?s.appendChild(this.createCombatView(t,r)):t.phase==="event"&&r?.event?s.appendChild(this.createEventView(t,r)):t.phase==="shop"&&r?.shopInventory?s.appendChild(this.createShopView(t,r)):t.phase==="puzzle"&&r?.puzzle?s.appendChild(this.createPuzzleView(t,r)):t.phase==="treasure"?s.appendChild(this.createTreasureView(t,r)):s.appendChild(this.createRoomView(t,r));let o=document.createElement("div");o.className="action-area",o.id="action-area",s.appendChild(o),e.appendChild(s);let i=this.createRightSidebar(t);e.appendChild(i);let l=document.createElement("div");return l.className="seed-display",l.innerHTML=`
            <span class="seed-label">Seed:</span>
            <span class="seed-value" title="Click to copy">${t.seed}</span>
        `,l.querySelector(".seed-value")?.addEventListener("click",()=>{navigator.clipboard.writeText(t.seed).then(()=>{let m=l.querySelector(".seed-value");m&&(m.textContent="Copied!",setTimeout(()=>{m.textContent=t.seed},1500))})}),e.appendChild(l),e}createPlayerSidebar(t){let e=document.createElement("aside");if(e.className="sidebar sidebar-left",!t.player)return e.innerHTML="<p>No player</p>",e;let n=t.player,s=Oe(n.playerClass,80);return e.innerHTML=`
            <div class="player-info">
                <img src="${s}" alt="${n.playerClass}" class="player-portrait" />
                <h2 class="player-name">${n.name}</h2>
                <div class="player-class">${n.playerClass} Lv.${n.level}</div>
            </div>
            
            <div class="stat-bars">
                <div class="stat-bar health-bar">
                    <div class="stat-bar-label">
                        <span>HP</span>
                        <span>${n.stats.health}/${n.getMaxHealth()}</span>
                    </div>
                    <div class="stat-bar-track">
                        <div class="stat-bar-fill" style="width: ${n.stats.health/n.getMaxHealth()*100}%"></div>
                    </div>
                </div>
                
                <div class="stat-bar mana-bar">
                    <div class="stat-bar-label">
                        <span>MP</span>
                        <span>${n.stats.mana}/${n.getMaxMana()}</span>
                    </div>
                    <div class="stat-bar-track">
                        <div class="stat-bar-fill" style="width: ${n.stats.mana/n.getMaxMana()*100}%"></div>
                    </div>
                </div>
                
                <div class="stat-bar xp-bar">
                    <div class="stat-bar-label">
                        <span>XP</span>
                        <span>${n.experience}/${ce(n.level)}</span>
                    </div>
                    <div class="stat-bar-track">
                        <div class="stat-bar-fill" style="width: ${we(n.level,n.experience)}%"></div>
                    </div>
                </div>
            </div>
            
            <div class="player-stats">
                <div class="stat-row">
                    <span class="stat-icon">&#9876;</span>
                    <span class="stat-label">Attack</span>
                    <span class="stat-value">${n.getAttackPower()}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-icon">&#128737;</span>
                    <span class="stat-label">Defense</span>
                    <span class="stat-value">${n.getDefense()}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-icon">&#9889;</span>
                    <span class="stat-label">Speed</span>
                    <span class="stat-value">${n.getSpeed()}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-icon">&#10026;</span>
                    <span class="stat-label">Crit</span>
                    <span class="stat-value">${n.getCritChance()}%</span>
                </div>
            </div>
            
            <div class="player-gold">
                <span class="gold-icon">&#9733;</span>
                <span class="gold-amount">${n.gold}</span>
                <span class="gold-label">Gold</span>
            </div>
            
            ${n.relics.length>0?`
            <div class="player-relics">
                <h3>Relics (${n.relics.length})</h3>
                <div class="relic-list">
                    ${n.relics.slice(0,5).map(r=>`
                        <div class="relic-item relic-${r.rarity}" title="${r.description}">
                            <span class="relic-icon">${this.getRelicIcon(r.type)}</span>
                            <span class="relic-name">${r.name}</span>
                        </div>
                    `).join("")}
                    ${n.relics.length>5?`<div class="relic-more">+${n.relics.length-5} more</div>`:""}
                </div>
            </div>
            `:""}
            
            <div class="game-stats">
                <div class="game-stat">Rooms: ${t.stats.roomsCleared}</div>
                <div class="game-stat">Enemies: ${t.stats.enemiesDefeated}</div>
            </div>
        `,e}getRelicIcon(t){switch(t){case"ability":return"&#10024;";case"stat_boost":return"&#9650;";case"passive":return"&#9711;";case"combat_modifier":return"&#9876;";default:return"&#10070;"}}createRightSidebar(t){let e=document.createElement("aside");e.className="sidebar sidebar-right";let n=this.createMinimap(t);e.appendChild(n);let s=document.createElement("div");return s.className="message-log",s.innerHTML=`
            <h3>Log</h3>
            <div class="log-entries">
                ${this.messageLog.slice(-8).map(r=>`<div class="log-entry">${r}</div>`).join("")}
            </div>
        `,e.appendChild(s),e}createMinimap(t){let e=document.createElement("div");e.className="minimap";let n=this.getCurrentRoom(t),s=n?.level??1,r=new Set,o=new Set(n?.connections??[]);if(n){let u=t.dungeon.layers.find(f=>f.level===s-1);u&&u.rooms.forEach(f=>{f.connections.includes(n.id)&&r.add(f.id)})}e.innerHTML=`
            <div class="minimap-header">
                <h3>Dungeon Map</h3>
                <span class="current-level">Level ${s}</span>
            </div>
        `;let i=document.createElement("div");i.className="minimap-content";let l=[s-1,s,s+1].filter(u=>u>=1),m=new Map;l.forEach(u=>{let f=t.dungeon.layers.find(h=>h.level===u);f&&f.rooms.forEach((h,b)=>{m.set(h.id,{level:u,index:b,total:f.rooms.length})})}),l.forEach(u=>{let f=t.dungeon.layers.find(E=>E.level===u);if(!f)return;let h=document.createElement("div");h.className=`minimap-level ${u===s?"current-level-row":""}`,h.dataset.level=u.toString();let b=document.createElement("div");b.className="minimap-level-label",u<s?b.innerHTML=`<span class="level-arrow up">&#9650;</span> L${u}`:u>s?b.innerHTML=`L${u} <span class="level-arrow down">&#9660;</span>`:b.innerHTML=`<span class="level-marker">&#9654;</span> L${u}`,h.appendChild(b);let R=document.createElement("div");R.className="minimap-rooms",f.rooms.forEach((E,ft)=>{let C=document.createElement("div");C.className=`minimap-room ${E.state.toLowerCase()} room-${E.type.toLowerCase()}`,C.dataset.roomId=E.id,E.id===t.dungeon.currentRoomId&&C.classList.add("current"),r.has(E.id)&&C.classList.add("came-from"),o.has(E.id)&&E.id!==t.dungeon.currentRoomId&&C.classList.add("can-go-to"),C.innerHTML=this.getRoomIcon(E.type);let J=E.state==="cleared"?"Cleared":E.state==="available"?"Available":E.state==="active"?"Current":"Locked";r.has(E.id)&&(J+=" (Came from)"),o.has(E.id)&&E.state==="available"&&(J+=" (Can go)"),C.title=`${this.formatRoomType(E.type)} - ${J}`,R.appendChild(C)}),h.appendChild(R),i.appendChild(h)});let d=document.createElement("div");return d.className="minimap-legend",d.innerHTML=`
            <div class="legend-item"><span class="legend-dot current"></span> Current</div>
            <div class="legend-item"><span class="legend-dot came-from"></span> Came From</div>
            <div class="legend-item"><span class="legend-dot can-go-to"></span> Can Go To</div>
            <div class="legend-item"><span class="legend-dot locked"></span> Locked</div>
        `,e.appendChild(i),e.appendChild(d),e}formatRoomType(t){return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}createInventoryOverlay(t){let e=document.createElement("div");e.className="inventory-overlay";let n=document.createElement("div");n.className="inventory-modal";let s=document.createElement("div");if(s.className="inventory-header",s.innerHTML=`
            <h2>Inventory</h2>
            <button class="close-btn" data-action="close_inventory">X</button>
        `,n.appendChild(s),!t.player)return n.innerHTML+="<p>No player data</p>",e.appendChild(n),e;let r=t.player,o=document.createElement("div");o.className="inventory-content";let i=document.createElement("div");i.className="equipment-section";let l=r.equipment.weapon?O(r.equipment.weapon.type,r.equipment.weapon.rarity,48):"",m=r.equipment.armor?O(r.equipment.armor.type,r.equipment.armor.rarity,48):"",d=r.equipment.accessory?O(r.equipment.accessory.type,r.equipment.accessory.rarity,48):"";i.innerHTML=`
            <h3>Equipment</h3>
            <div class="equipment-slots">
                <div class="equipment-slot" data-slot="weapon">
                    <div class="slot-label">Weapon</div>
                    <div class="slot-item ${r.equipment.weapon?"filled":"empty"}">
                        ${r.equipment.weapon?`<img src="${l}" alt="${r.equipment.weapon.name}" class="equipment-image" />
                               <span class="item-name">${r.equipment.weapon.name}</span>
                               <button class="unequip-btn" data-action="unequip_item" data-slot="weapon">Unequip</button>`:'<span class="empty-slot">Empty</span>'}
                    </div>
                </div>
                <div class="equipment-slot" data-slot="armor">
                    <div class="slot-label">Armor</div>
                    <div class="slot-item ${r.equipment.armor?"filled":"empty"}">
                        ${r.equipment.armor?`<img src="${m}" alt="${r.equipment.armor.name}" class="equipment-image" />
                               <span class="item-name">${r.equipment.armor.name}</span>
                               <button class="unequip-btn" data-action="unequip_item" data-slot="armor">Unequip</button>`:'<span class="empty-slot">Empty</span>'}
                    </div>
                </div>
                <div class="equipment-slot" data-slot="accessory">
                    <div class="slot-label">Accessory</div>
                    <div class="slot-item ${r.equipment.accessory?"filled":"empty"}">
                        ${r.equipment.accessory?`<img src="${d}" alt="${r.equipment.accessory.name}" class="equipment-image" />
                               <span class="item-name">${r.equipment.accessory.name}</span>
                               <button class="unequip-btn" data-action="unequip_item" data-slot="accessory">Unequip</button>`:'<span class="empty-slot">Empty</span>'}
                    </div>
                </div>
            </div>
            <div class="gold-display">
                <span class="gold-icon">G</span>
                <span class="gold-amount">${r.gold}</span>
            </div>
        `,o.appendChild(i);let u=document.createElement("div");u.className="inventory-grid-section",u.innerHTML=`<h3>Items (${r.inventory.length})</h3>`;let f=document.createElement("div");return f.className="inventory-grid",r.inventory.length===0?f.innerHTML='<div class="empty-inventory">No items in inventory</div>':r.inventory.forEach(h=>{let b=O(h.type,h.rarity,40),R=document.createElement("div");R.className=`inventory-item item-${h.type.toLowerCase()} rarity-${h.rarity.toLowerCase()}`,R.innerHTML=`
                    <img src="${b}" alt="${h.name}" class="item-image" />
                    <div class="item-info">
                        <span class="item-name">${h.name}</span>
                        <span class="item-type">${h.type}</span>
                    </div>
                    <div class="item-actions">
                        ${this.getItemActions(h)}
                    </div>
                `,f.appendChild(R)}),u.appendChild(f),o.appendChild(u),n.appendChild(o),e.appendChild(n),e.addEventListener("click",h=>{let b=h.target,R=b.dataset.action;if(R==="close_inventory")this.actionResolver&&this.actionResolver({type:"close_inventory"});else if(R==="unequip_item"){let E=b.dataset.slot;this.actionResolver&&E&&this.actionResolver({type:"unequip_item",slot:E})}else if(R==="equip_item"){let E=b.dataset.itemId;this.actionResolver&&E&&this.actionResolver({type:"equip_item",itemId:E})}else if(R==="use_item"){let E=b.dataset.itemId;this.actionResolver&&E&&this.actionResolver({type:"use_item",itemId:E})}}),e.addEventListener("click",h=>{h.target===e&&this.actionResolver&&this.actionResolver({type:"close_inventory"})}),e}getItemActions(t){switch(t.type.toLowerCase()){case"weapon":case"armor":case"accessory":return`<button class="item-action-btn" data-action="equip_item" data-item-id="${t.id}">Equip</button>`;case"consumable":return`<button class="item-action-btn" data-action="use_item" data-item-id="${t.id}">Use</button>`;default:return""}}createCharacterOverlay(t){let e=document.createElement("div");e.className="character-overlay";let n=document.createElement("div");n.className="character-modal";let s=document.createElement("div");if(s.className="character-header",s.innerHTML=`
            <h2>Character Sheet</h2>
            <button class="close-btn" data-action="close_character">X</button>
        `,n.appendChild(s),!t.player)return n.innerHTML+="<p>No player data</p>",e.appendChild(n),e;let r=t.player,o=document.createElement("div");return o.className="character-content",o.innerHTML=`
            <div class="character-info">
                <h3>${r.name}</h3>
                <p class="character-class">${r.playerClass} - Level ${r.level}</p>
            </div>
            
            <div class="character-stats">
                <h4>Stats</h4>
                <div class="stat-grid">
                    <div class="stat-item">
                        <span class="stat-label">Health</span>
                        <span class="stat-value">${r.stats.health}/${r.getMaxHealth()}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Mana</span>
                        <span class="stat-value">${r.stats.mana}/${r.getMaxMana()}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Attack</span>
                        <span class="stat-value">${r.getAttackPower()}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Defense</span>
                        <span class="stat-value">${r.getDefense()}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Speed</span>
                        <span class="stat-value">${r.getSpeed()}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Crit Chance</span>
                        <span class="stat-value">${r.getCritChance()}%</span>
                    </div>
                </div>
            </div>
            
            <div class="character-abilities">
                <h4>Abilities</h4>
                <div class="ability-list">
                    ${r.abilities.map(i=>`
                        <div class="ability-item ${i.currentCooldown>0?"on-cooldown":""}">
                            <span class="ability-name">${i.name}</span>
                            <span class="ability-cost">${i.manaCost} MP</span>
                            ${i.currentCooldown>0?`<span class="ability-cd">(${i.currentCooldown} turns)</span>`:""}
                        </div>
                    `).join("")}
                </div>
            </div>
            
            <div class="character-experience">
                <h4>Experience</h4>
                <p>XP: ${r.experience} / ${ce(r.level)}</p>
                <p>Gold: ${r.gold}</p>
            </div>
        `,n.appendChild(o),e.appendChild(n),e.addEventListener("click",i=>{(i.target.dataset.action==="close_character"||i.target===e)&&this.actionResolver&&this.actionResolver({type:"close_character"})}),e}createRoomView(t,e){let n=document.createElement("div");if(n.className="room-view",!e)return n.innerHTML="<p>No room</p>",n;n.innerHTML=`
            <div class="room-header">
                <span class="room-icon">${this.getRoomIcon(e.type)}</span>
                <h2 class="room-title">${this.getRoomTitle(e.type)}</h2>
                <span class="room-level">Level ${e.level}</span>
            </div>
            <p class="room-description">${e.description}</p>
        `;let s=e.getAvailableInteractables();if(s.length>0){let o=document.createElement("div");o.className="room-interactables",o.innerHTML=`
                <h3>Objects</h3>
                <div class="interactable-list">
                    ${s.map(i=>`
                        <div class="interactable-item">
                            <span class="interactable-icon">${this.getInteractableIcon(i.type)}</span>
                            <span class="interactable-name">${i.name}</span>
                        </div>
                    `).join("")}
                </div>
            `,n.appendChild(o)}let r=this.getConnectedRooms(t,e);if(r.length>0){let o=document.createElement("div");o.className="room-connections",o.innerHTML=`
                <h3>Paths</h3>
                <div class="connection-list">
                    ${r.map(i=>`
                        <div class="connection-item ${i.canEnter()?"available":"locked"}">
                            <span class="connection-icon">${this.getRoomIcon(i.type)}</span>
                            <span class="connection-name">${this.getRoomTitle(i.type)}</span>
                            <span class="connection-status">${i.state}</span>
                        </div>
                    `).join("")}
                </div>
            `,n.appendChild(o)}return n}createEventView(t,e){let n=document.createElement("div");n.className="event-view";let s=e.event;if(!s)return n.innerHTML="<p>No event</p>",n;let r=s.outcome,o=r.isPositive?"positive":"negative";return n.innerHTML=`
            <div class="event-container">
                <div class="event-header">
                    <span class="event-icon">${this.getEventIcon(r.type)}</span>
                    <h2 class="event-title">${s.title}</h2>
                </div>
                
                <div class="event-description">
                    <p>${s.description}</p>
                </div>
                
                <div class="event-outcome ${o}">
                    <div class="outcome-icon">${r.isPositive?"\u2728":"\u{1F480}"}</div>
                    <div class="outcome-details">
                        <h3 class="outcome-name">${r.name}</h3>
                        <p class="outcome-description">${r.description}</p>
                        ${this.getOutcomeDetails(r)}
                    </div>
                </div>
                
                <div class="event-hint">
                    <p>Click "Accept Your Fate" to continue...</p>
                </div>
            </div>
        `,n}getEventIcon(t){return{buff:"\u2B06\uFE0F",debuff:"\u2B07\uFE0F",weapon:"\u2694\uFE0F",armor:"\u{1F6E1}\uFE0F",potion:"\u{1F9EA}",gold:"\u{1F4B0}",heal:"\u{1F49A}",damage:"\u{1F494}"}[t]||"\u2753"}getOutcomeDetails(t){switch(t.type){case"buff":case"debuff":return t.statBonus?`<div class="outcome-stats">${Object.entries(t.statBonus).map(([n,s])=>`<span class="stat-change ${s>0?"positive":"negative"}">${s>0?"+":""}${s} ${n}</span>`).join(", ")} for ${t.duration} turns</div>`:"";case"weapon":case"armor":case"potion":return t.item?`<div class="outcome-item">Received: ${t.item.name}</div>`:"";case"gold":return t.gold?`<div class="outcome-gold">+${t.gold} gold</div>`:"";case"heal":return t.healthChange?`<div class="outcome-heal">Heals ${Math.floor(t.healthChange*100)}% of max HP</div>`:"";case"damage":return t.healthChange?`<div class="outcome-damage">Deals ${Math.floor(Math.abs(t.healthChange)*100)}% of max HP</div>`:"";default:return""}}createPuzzleView(t,e){let n=document.createElement("div");n.className="puzzle-view";let s=e.puzzle;if(!s)return n.innerHTML="<p>No puzzle here</p>",n;let r=s.maxAttempts-s.attempts,o=r<=1?"attempts-critical":r<=2?"attempts-warning":"";return n.innerHTML=`
            <div class="puzzle-header">
                <span class="puzzle-icon">${this.getPuzzleIcon(s.type)}</span>
                <h2 class="puzzle-title">${s.title}</h2>
            </div>
            <div class="puzzle-attempts ${o}">
                <span>Attempts remaining: ${r}</span>
            </div>
            <div class="puzzle-question">
                <p>${s.question}</p>
            </div>
            <div class="puzzle-options">
                ${s.options.map((i,l)=>`
                    <button class="puzzle-option" 
                            data-action="puzzle_answer" 
                            data-answer-index="${l}">
                        ${i}
                    </button>
                `).join("")}
            </div>
            <div class="puzzle-actions">
                <button class="skip-puzzle-btn" data-action="skip_puzzle">
                    Skip Puzzle (forfeit rewards)
                </button>
            </div>
        `,n.addEventListener("click",i=>{let l=i.target,m=l.dataset.action;if(m==="puzzle_answer"&&this.actionResolver){let d=parseInt(l.dataset.answerIndex||"0",10);this.actionResolver({type:"puzzle_answer",answerIndex:d})}else m==="skip_puzzle"&&this.actionResolver&&this.actionResolver({type:"skip_puzzle"})}),n}getPuzzleIcon(t){switch(t){case"riddle":return"\u{1F9E9}";case"sequence":return"\u{1F52E}";case"math":return"\u{1F522}";default:return"\u2753"}}createTreasureView(t,e){let n=document.createElement("div");if(n.className="treasure-view",!e)return n.innerHTML="<p>No room</p>",n;let r=e.interactables.filter(i=>!i.used).length>0;if(n.innerHTML=`
            <div class="treasure-header">
                <span class="treasure-icon">\u{1F48E}</span>
                <h2 class="treasure-title">Treasure Chamber</h2>
            </div>
            <p class="treasure-description">${e.description||"A room filled with glittering treasures..."}</p>
        `,r){let i=document.createElement("div");i.className="interactables-grid",e.interactables.forEach((l,m)=>{let d=document.createElement("div");d.className=`interactable-card ${l.used?"used":"available"}`,d.innerHTML=`
                    <span class="interactable-icon">${this.getInteractableIcon(l.type)}</span>
                    <span class="interactable-name">${l.name}</span>
                    ${l.used?'<span class="used-label">Used</span>':`
                        <button class="interact-btn" 
                                data-action="interact" 
                                data-index="${m}">
                            ${this.getInteractableAction(l.type)}
                        </button>
                    `}
                `,i.appendChild(d)}),n.appendChild(i)}else n.innerHTML+='<p class="no-treasures">All treasures have been claimed.</p>';let o=document.createElement("button");return o.className="leave-treasure-btn",o.textContent="Leave Room",o.dataset.action="leave",n.appendChild(o),n.addEventListener("click",i=>{let l=i.target,m=l.dataset.action;if(m==="interact"&&this.actionResolver){let d=parseInt(l.dataset.index||"0",10);this.actionResolver({type:"interact",interactableIndex:d})}else m==="leave"&&this.actionResolver&&this.actionResolver({type:"leave"})}),n}getInteractableAction(t){switch(t){case"chest":return"Open";case"trap":return"Disarm";case"altar":return"Pray";case"lever":return"Pull";case"npc":return"Talk";default:return"Interact"}}createShopView(t,e){let n=document.createElement("div");n.className="shop-view";let s=t.player;if(!s||!e.shopInventory)return n.innerHTML="<p>Shop not available</p>",n;n.innerHTML=`
            <div class="shop-header">
                <span class="shop-icon">\u{1F3EA}</span>
                <h2 class="shop-title">Merchant's Wares</h2>
                <div class="player-gold">
                    <span class="gold-icon">G</span>
                    <span class="gold-amount">${s.gold}</span>
                </div>
            </div>
            <p class="shop-description">"Welcome, adventurer! Browse my finest goods..."</p>
        `;let r=document.createElement("div");r.className="shop-content";let o=document.createElement("div");o.className="shop-section for-sale",o.innerHTML="<h3>For Sale</h3>";let i=document.createElement("div");i.className="shop-grid",e.shopInventory.length===0?i.innerHTML='<p class="empty-shop">Sold out!</p>':e.shopInventory.forEach(d=>{let u=s.gold>=d.buyPrice,f=O(d.item.type,d.item.rarity,48),h=document.createElement("div");h.className=`shop-item ${u?"affordable":"too-expensive"} item-${d.item.type.toLowerCase()} rarity-${d.item.rarity.toLowerCase()}`,h.innerHTML=`
                    <img src="${f}" alt="${d.item.name}" class="shop-item-image" />
                    <div class="item-info">
                        <span class="item-name">${d.item.name}</span>
                        <span class="item-type">${d.item.type}</span>
                        ${d.item.description?`<span class="item-desc">${d.item.description}</span>`:""}
                    </div>
                    <div class="item-price">
                        <span class="price-amount">${d.buyPrice}</span>
                        <span class="price-label">gold</span>
                    </div>
                    <button class="buy-btn ${u?"":"disabled"}" 
                            data-action="buy_item" 
                            data-item-id="${d.item.id}"
                            ${u?"":"disabled"}>
                        ${u?"Buy":"Cannot Afford"}
                    </button>
                `,i.appendChild(h)}),o.appendChild(i),r.appendChild(o);let l=document.createElement("div");l.className="shop-section for-sell",l.innerHTML="<h3>Your Items</h3>";let m=document.createElement("div");return m.className="shop-grid",s.inventory.length===0?m.innerHTML='<p class="empty-inventory">No items to sell</p>':s.inventory.forEach(d=>{let u=Math.floor(d.value*.5),f=O(d.type,d.rarity,48),h=document.createElement("div");h.className=`shop-item sellable item-${d.type.toLowerCase()} rarity-${d.rarity.toLowerCase()}`,h.innerHTML=`
                    <img src="${f}" alt="${d.name}" class="shop-item-image" />
                    <div class="item-info">
                        <span class="item-name">${d.name}</span>
                        <span class="item-type">${d.type}</span>
                    </div>
                    <div class="item-price sell-price">
                        <span class="price-amount">${u}</span>
                        <span class="price-label">gold</span>
                    </div>
                    <button class="sell-btn" 
                            data-action="sell_item" 
                            data-item-id="${d.id}">
                        Sell
                    </button>
                `,m.appendChild(h)}),l.appendChild(m),r.appendChild(l),n.appendChild(r),n.addEventListener("click",d=>{let u=d.target,f=u.dataset.action,h=u.dataset.itemId;f&&h&&this.actionResolver&&this.actionResolver({type:f,itemId:h})}),n}createCombatView(t,e){let n=document.createElement("div");if(n.className="combat-view",!e||!e.enemies)return n.innerHTML="<p>No enemies</p>",n;n.innerHTML=`
            <div class="combat-header">
                <h2>Combat!</h2>
            </div>
        `;let s=document.createElement("div");return s.className="enemies-list",e.enemies.forEach((r,o)=>{let i=document.createElement("div");i.className=`enemy-card ${r.health<=0?"defeated":""}`,i.dataset.enemyId=r.id;let l=r.health/r.maxHealth*100,m=Le(r.type,r.name,120),d=r.imageUrl||m;i.innerHTML=`
                <img src="${d}" 
                     alt="${r.name}" 
                     class="enemy-image ${r.imageUrl?"api-image":"placeholder-image"}"
                     onerror="this.src='${m}'; this.classList.remove('api-image'); this.classList.add('placeholder-image');" />
                <div class="enemy-header">
                    <span class="enemy-name">${r.name}</span>
                    <span class="enemy-cr">CR ${r.challengeRating}</span>
                </div>
                <div class="enemy-hp-bar">
                    <div class="enemy-hp-fill" style="width: ${l}%"></div>
                    <span class="enemy-hp-text">${r.health}/${r.maxHealth}</span>
                </div>
                <div class="enemy-stats">
                    <span>ATK<br/>${r.attackPower}</span>
                    <span>DEF<br/>${r.defense}</span>
                </div>
            `,s.appendChild(i)}),n.appendChild(s),n}renderActionButtons(t){let e=this.container.querySelector("#action-area");if(!e)return;e.innerHTML="<h3>Actions</h3>";let n=document.createElement("div");n.className="action-buttons",t.forEach((s,r)=>{let o=document.createElement("button");o.className=`action-btn action-${s.type}`,o.innerHTML=`
                <span class="action-key">${r+1}</span>
                <span class="action-label">${this.getActionLabel(s)}</span>
            `,o.addEventListener("click",()=>{this.actionResolver&&(this.actionResolver(s),this.actionResolver=null)}),n.appendChild(o)}),e.appendChild(n)}renderTargetSelection(t){let e=this.getState(),n=this.getCurrentRoom(e);if(!n||!n.enemies)return;let s=document.createElement("div");s.className="target-overlay",s.innerHTML="<h3>Select Target</h3>";let r=document.createElement("div");r.className="target-list",t.forEach(o=>{let i=n.enemies?.find(m=>m.id===o);if(!i)return;let l=document.createElement("button");l.className="target-btn",l.innerHTML=`
                <span class="target-name">${i.name}</span>
                <span class="target-hp">${i.health}/${i.maxHealth} HP</span>
            `,l.addEventListener("click",()=>{this.targetResolver&&(this.targetResolver(o),this.targetResolver=null,s.remove())}),r.appendChild(l)}),s.appendChild(r),this.container.appendChild(s)}displayActions(t){}displayResult(t){if(t.message){let n=t.message;if(t.result?.item){let s=t.result.item,r=this.formatItemName(s.name,s.rarity);n=n.replace(s.name,r)}if(t.result?.gold!==void 0){let s=Math.abs(t.result.gold);n=n.replace(new RegExp(`${s}\\s*gold`,"gi"),`${this.formatName(s.toString(),"gold")} gold`)}switch(t.type){case"item_bought":case"item_sold":case"item_equipped":case"item_unequipped":case"item_used":break;case"rested":n=`${this.formatName("Rested","heal")}: ${t.message}`;break;case"flee":t.success?n=`${this.formatName("Escaped!","heal")} You fled from combat.`:n=`${this.formatName("Failed to escape!","damage")} The enemies block your path.`;break;case"moved":n=`Entered a new ${this.formatName("room","room")}.`;break;case"interacted":break;case"event":n=this.formatEventMessage(t.message);break}this.addLogMessage(n)}let e=this.getState();this.render(e)}displayCombatState(){let t=this.getState();this.render(t)}displayStatusEffectMessages(t){t.forEach(e=>this.addLogMessage(e))}displayAttackResult(t){let{attacker:e,defender:n,attackRoll:s,damage:r,defenderDied:o}=t,i="id"in e&&typeof e.id=="string"&&e.id.includes("-")?"enemy":"player",l=i==="player"?"enemy":"player",m=this.formatName(e.name,i),d=this.formatName(n.name,l),u=`${m} attacks ${d}`;s.isNatural20?u+=` - ${this.formatName("CRITICAL HIT!","crit")}`:s.isNatural1?u+=` - ${this.formatName("Miss!","miss")}`:s.isHit||(u+=` - ${this.formatName("Miss","miss")} (${s.total} vs ${s.targetDefense})`),r&&(u+=` for ${this.formatName(r.finalDamage.toString(),"damage")} damage`,r.isCritical&&(u+=` ${this.formatName("(crit!)","crit")}`)),o&&(u+=` - ${d} ${this.formatName("defeated!","crit")}`),this.addLogMessage(u);let f=this.getState();this.render(f)}displayAbilityResult(t){let e=this.formatName(t.abilityName,"ability"),n=t.message;if(t.healing?n=`${e}: Healed for ${this.formatName(t.healing.toString(),"heal")} HP`:t.damage&&(t.isAoe?n=`${e}: Dealt ${this.formatName(t.damage.toString(),"damage")} total damage to all enemies!`:n=`${e}: Dealt ${this.formatName(t.damage.toString(),"damage")} damage`),t.effectApplied&&(n+=` [${this.formatName(t.effectApplied,"ability")}]`),t.enemiesKilled.length>0){let r=t.enemiesKilled.length;n+=` - ${this.formatName(r.toString(),"damage")} ${r===1?"enemy":"enemies"} ${this.formatName("defeated!","crit")}`}this.addLogMessage(n);let s=this.getState();this.render(s)}displayRoomRewards(t){if(this.addLogMessage(`${this.formatName("Victory!","crit")} You cleared the room!`),t.gold>0&&this.addLogMessage(`Received ${this.formatName(t.gold.toString(),"gold")} gold`),t.experience>0&&this.addLogMessage(`Gained ${this.formatName(t.experience.toString(),"ability")} XP`),t.items.length>0){let n=t.items.map(s=>this.formatItemName(s.name,s.rarity)).join(", ");this.addLogMessage(`Found: ${n}`)}t.healthRestore&&t.healthRestore>0&&this.addLogMessage(`Restored ${this.formatName(t.healthRestore.toString(),"heal")} HP`);let e=this.getState();this.render(e)}handleGameOver(){super.handleGameOver(),this.showEndScreen("Game Over","You have been defeated...")}handleVictory(){super.handleVictory(),this.showEndScreen("Victory!","You have conquered the dungeon!")}showEndScreen(t,e){let n=this.getState();this.container.innerHTML=`
            <div class="end-screen">
                <h1 class="end-title">${t}</h1>
                <p class="end-message">${e}</p>
                
                <div class="end-stats">
                    <h3>Final Stats</h3>
                    <div class="stat-row">
                        <span>Rooms Cleared:</span>
                        <span>${n.stats.roomsCleared}</span>
                    </div>
                    <div class="stat-row">
                        <span>Enemies Defeated:</span>
                        <span>${n.stats.enemiesDefeated}</span>
                    </div>
                    <div class="stat-row">
                        <span>Gold Collected:</span>
                        <span>${n.stats.goldCollected}</span>
                    </div>
                    <div class="stat-row">
                        <span>Items Found:</span>
                        <span>${n.stats.itemsFound}</span>
                    </div>
                </div>
                
                <button class="restart-btn" onclick="location.reload()">Play Again</button>
            </div>
        `}getCurrentRoom(t){return t.dungeon.currentRoomId?t.dungeon.rooms.get(t.dungeon.currentRoomId)??null:null}getConnectedRooms(t,e){return e.connections.map(n=>t.dungeon.rooms.get(n)).filter(n=>n!==void 0)}addLogMessage(t){this.messageLog.push(t),this.messageLog.length>xe&&this.messageLog.shift()}getRoomIcon(t){return{entrance:"&#128682;",combat:"&#9876;",elite:"&#128128;",boss:"&#128123;",treasure:"&#128176;",rest:"&#128293;",shop:"&#127978;",event:"&#10067;",puzzle:"&#128273;"}[t]||"?"}getRoomTitle(t){return{entrance:"Dungeon Entrance",combat:"Combat Room",elite:"Elite Encounter",boss:"Boss Chamber",treasure:"Treasure Room",rest:"Rest Area",shop:"Merchant",event:"Mysterious Event",puzzle:"Puzzle Chamber"}[t]||t}getInteractableIcon(t){return{chest:"&#128230;",trap:"&#9888;",altar:"&#9962;",lever:"&#128295;",npc:"&#128100;"}[t]||"?"}getActionLabel(t){switch(t.type){case"move":return`Go to ${this.getRoomTitle(t.roomType)}`;case"interact":return`Interact: ${t.name}`;case"basic_attack":return"Attack";case"ability":return t.name||t.abilityId||"Use Ability";case"use_item":return`Use ${t.name||t.itemName}`;case"flee":return"Flee";case"rest":return"Rest";case"leave":case"leave_shop":return"Leave";case"open_inventory":return"Inventory";case"view_character":return"Character";case"restart":return"Restart";case"quit":return"Quit";default:return t.type}}};function Pe(){let c=document.getElementById("character-select"),a=document.getElementById("loading-screen"),t=document.getElementById("game-screen"),e=document.getElementById("start-game"),n=document.getElementById("player-name"),s=document.getElementById("game-seed"),r=document.querySelectorAll(".class-card"),o=null;function i(m){r.forEach(d=>d.classList.remove("selected")),m.classList.add("selected"),o=m.getAttribute("data-class"),l()}r.forEach(m=>{m.addEventListener("click",()=>i(m)),m.addEventListener("keydown",d=>{(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),i(m))})}),n.addEventListener("input",l);function l(){let m=n.value.trim().length>0,d=o!==null,u=m&&d;console.log("updateStartButton:",{hasName:m,hasClass:d,shouldEnable:u,nameValue:n.value,selectedClass:o}),e.disabled=!u}e.addEventListener("click",async()=>{if(!o)return;let m=n.value.trim()||"Hero",d=s.value.trim()||void 0;c?.classList.add("hidden"),a?.classList.remove("hidden");try{let u;o==="fighter"?u=new k(m):u=new _(m),await new Promise(h=>setTimeout(h,500)),a?.classList.add("hidden"),t?.classList.remove("hidden"),await new Q("game-screen").startGame(u,d)}catch(u){console.error("Failed to start game:",u),a?.classList.add("hidden"),c?.classList.remove("hidden"),alert("Failed to start game. Please try again.")}}),n.value="Hero",n.dispatchEvent(new Event("input",{bubbles:!0})),l()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Pe):Pe();
